<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../../Lib/paper-spinner/paper-spinner.html" />
<link rel="stylesheet" href="../p4m-shared/p4m.css" />

<dom-module id="p4m-purchase">

    <template>
        <div id="p4mPurchaseContainer" class$="{{_topClass}}">
            <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
            <polymer-cookie id="p4mAvatarCookie" name="p4mAvatarUrl"></polymer-cookie>
            <polymer-cookie id="p4mGivenNameCookie" name="p4mGivenName"></polymer-cookie>
            <p4m-api id="localApi" is-local="true"></p4m-api>
            <paper-spinner id="spinner"></paper-spinner>
            <div id="p4mBuyNowBtn" on-tap="buyNow" class="p4m-button p4m-button-active">{{buttonText}}</div> 
            <a href="#" on-click="showOverlay">Show overlay</a>       
        </div>
        <div id="overlay" class="p4m-overlay overlay">Hello</div>
    </template>

    <style>

        #p4m-purchase-container {
            display: flex;
            flex-direction: row;
        }
        #spinner {
            width: 50px;
            height: 50px;
        }
        .hidden {
            display: none;
        }

        .overlay {
	        position: fixed;
	        width: 100%;
	        height: 100%;
	        top: 0;
	        left: 0;
	        background: rgba(76,102,25,0.9);
        }

        .p4m-overlay {
	        opacity: 0;
	        visibility: hidden;
	        transition: opacity 0.5s, visibility 0s 0.5s;
        }

        .p4m-overlay.open {
	        opacity: 1;
	        visibility: visible;
	        transition: opacity 0.5s;
        }

        .p4m-overlay nav {
	        perspective: 1200px;
        }

    </style>

    <script>
    //
        Polymer({
            is: "p4m-purchase",

            properties: {
                cartData: {
                    type: Object,
                    notify: true,
                    observer: "onCartDataChange"
                },
                buttonText: {
                    type: String,
                    value: "Buy now"
                },
                _topClass: {
                    type: String,
                    value: "active"
                }
            },
            observers: [
                "onCartDataChange(cartData.*)"
            ],

            ready: function()
            {
                this.load();
            },

            buyNow: function () {
                this.showAsBuying();
                this.$.localApi.call('purchase', { cartId: this.cartData.Id, cvv: '123' }, null, this.onPurchase.bind(this));
            },

            load: function () {
                //Check to see if the user is logged in
                var token = this.$.p4mTokenCookie.readCookie();
                this._loggedIn = token !== "";
                this.updateUi();
            },

            onCartDataChange: function (e) {
                this.updateUi();
            },

            onPurchase: function (e) {
                this.showAsCompleted();
            },

            updateUi: function (disable) {
                //Disable if truthy value passed, or not logged in, or no cart
                this.$.p4mBuyNowBtn.disabled = disable || !this._loggedIn || !this.cartData;
            },

            setLoadingState: function(loading) {
                if (loading) {
                    this.$.spinner.active = true;
                    this.$.spinner.classList.remove('hidden');
                    this.$.p4mBuyNowButton.classList.remove('p4m-button-active');
                    this._topClass = "loading";
                }
                else {
                    this.$.spinner.active = false;
                    this.$.spinner.classList.add('hidden');
                    this.$.p4mBuyNowButton.classList.add('p4m-button-active');
                    this._topClass = "active";
                }
            },

            showAsCompleted: function () {
                this.buttonText = "Purchase complete";
                this.setLoadingState(false);
                this.updateUi();
            },

            showAsBuying: function () {
                this.buttonText = "Please wait...";
                this.setLoadingState(true);
                this.updateUi(true);
            },

            showOverlay: function() {
                this.toggleOverlay(true);
            },

            toggleOverlay: function (show) {
                if (show) {
                    this.$.overlay.classList.add('open');
                }
                else {
                    this.$.overlay.classList.remove('open');
                }
            }
        });
    </script>
</dom-module>