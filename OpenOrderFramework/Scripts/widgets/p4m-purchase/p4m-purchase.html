<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../p4m-overlay/p4m-overlay.html" />
<link rel="import" href="../../Lib/paper-spinner/paper-spinner.html" />

<link rel="stylesheet" href="../p4m-shared/p4m.css" />

<dom-module id="p4m-purchase">

    <template>
        <div id="p4mPurchaseContainer" class$="{{_topClass}}">
            <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
            <polymer-cookie id="p4mAvatarCookie" name="p4mAvatarUrl"></polymer-cookie>
            <polymer-cookie id="p4mGivenNameCookie" name="p4mGivenName"></polymer-cookie>
            <p4m-api id="localApi" is-local="true"></p4m-api>
            <paper-spinner id="spinner"></paper-spinner>

            <div id="p4mBuyNowButton" on-tap="buyNow" class="p4m-button p4m-button-active">{{buttonText}}</div>
            <p class="p4m-error">{{errorMsg}}</p> 
      
        </div>
        <p4m-overlay id="overlay" with-backdrop></p4m-overlay>
    </template>

    <style>

        #p4m-purchase-container {
            display: flex;
            flex-direction: row;
        }
        #spinner {
            width: 50px;
            height: 50px;
        }
        .hidden {
            display: none;
        }
        --iron-overlay-backdrop-opacity {
            opacity: 0.9;
        }
        .p4m-error {
            color: red;
            font-weight: 500;
        }


    </style>

    <script>
        var States = {
            NOT_PURCHASED: 0,
            PURCHASING: 1,
            FAILED_PURCHASE: 2,
            PURCHASED: 3
        }
    //
        Polymer({
            is: "p4m-purchase",

            properties: {
                cartData: {
                    type: Object,
                    notify: true,
                    observer: "onCartDataChange"
                },
                btnMsgNotPurchased: {
                    type: String,
                    value: "Buy now"
                },
                btnMsgBuying: {
                    type: String,
                    value: "Please wait"
                },
                btnMsgComplete: {
                    type: String,
                    value: "Purchase complete"
                },
                btnMsgNotValid: {
                    type: String,
                    value: "Cart empty"
                },
                btnMsgFailed: {
                    type: String,
                    value: "Try again"
                },
                msgFailedPayment: {
                    type: String,
                    value: "Something went wrong. Please try again."
                },
                errorMsg: {
                    type: String
                },
                _topClass: {
                    type: String,
                    value: "active"
                },
                _state: {
                    type: String,
                    notify: true
                }
            },
            observers: [
                "onCartDataChange(cartData.*)",
                "onStateChange(_state)"
            ],

            ready: function ()
            {
                this.load();
            },

            onStateChange: function () {
                this.updateUi();
            },

            onCartDataChange: function () {
                this.updateUi();
            },

            buyNow: function () {
                if (this._state === States.NOT_PURCHASED || this._state === States.FAILED_PURCHASE) {
                    this._state = States.PURCHASING;
                    this.$.localApi.call('purchase', { cartId: this.cartData.Id, cvv: '123' }, null, this.onPurchase.bind(this));
                }
            },

            load: function () {
                //Check to see if the user is logged in
                var token = this.$.p4mTokenCookie.readCookie();
                this._loggedIn = token !== "";
                this._state = States.NOT_PURCHASED;
            },

            onPurchase: function (e) {
                console.log('onPurchase', e);
                if (e.Success == false) {
                    this.errorMsg = this.msgFailedPayment;
                    this._state = States.FAILED_PURCHASE;
                }
                else {                  
                    if (e.RedirectUrl) {
                        window.location.href = e.RedirectUrl;
                    }
                    else {
                        this._state = States.PURCHASED;
                    }
                }
            },

            updateUi: function () {
                //Disable if truthy value passed, or not logged in, or no cart
                if (!this._loggedIn || !this.cartData) {                    
                    this.showAsNotValid();
                }
                else if (this._state === States.NOT_PURCHASED) {
                    this.showAsNotPurchased();
                }
                else if (this._state == States.PURCHASING) {
                    this.showAsBuying();
                }
                else if (this._state == States.PURCHASED) {
                    this.showAsCompleted();
                }
                else if (this._state == States.FAILED_PURCHASE) {
                    this.showAsFailed();
                }
            },

            setLoadingState: function(loading) {
                if (loading) {
                    this.showOverlay();                  
                    this._topClass = "loading";
                }
                else {
                    this.hideOverlay();
                    this._topClass = "active";
                }
            },

            showAsNotPurchased: function() {
                this.buttonText = this.btnMsgNotPurchased;
                this.$.p4mBuyNowButton.classList.add('p4m-button-active');
                this.$.p4mBuyNowButton.classList.remove('disabled');
                this.setLoadingState(false);
                this.topClass = "active";
            },

            showAsNotValid: function () {
                this.buttonText = this.btnMsgNotValid; //"Cart empty";
                this.$.p4mBuyNowButton.classList.remove('p4m-button-active');
                this.$.p4mBuyNowButton.classList.add('disabled');
                this.setLoadingState(false);
                this.topClass = "invalid";
            },

            showAsBuying: function () {
                this.buttonText = this.btnMsgBuying;//"Please wait...";
                this.$.p4mBuyNowButton.classList.remove('p4m-button-active');
                this.$.p4mBuyNowButton.classList.add('disabled');
                this.setLoadingState(true);
                this.topClass = "buying";
            },

            showAsCompleted: function () {
                this.buttonText = this.btnMsgComplete; //"Purchase complete";
                this.$.p4mBuyNowButton.classList.remove('p4m-button-active');
                this.$.p4mBuyNowButton.classList.add('disabled');
                this.setLoadingState(false);
                this.topClass = "complete";
            },

            showAsFailed: function () {
                this.buttonText = this.btnMsgFailed;
                this.$.p4mBuyNowButton.classList.add('p4m-button-active');
                this.$.p4mBuyNowButton.classList.remove('disabled');
                this.setLoadingState(false);
                this.topClass = "failed";
            },

            showOverlay: function() {
                this.$.overlay.open();
            },

            hideOverlay: function () {
                this.$.overlay.close();
            }
        });
    </script>
</dom-module>