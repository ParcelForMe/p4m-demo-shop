<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../p4m-overlay/p4m-overlay.html" />

<link rel="stylesheet" href="../p4m-shared/p4m.css" />

<dom-module id="p4m-purchase">

    <template>
        <div id="p4mPurchaseContainer" class$="{{_topClass}}">
        
            <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
            <polymer-cookie id="p4mAvatarCookie" name="p4mAvatarUrl"></polymer-cookie>
            <polymer-cookie id="p4mGivenNameCookie" name="p4mGivenName"></polymer-cookie>
            <p4m-api id="localApi" is-local="true"></p4m-api>
            <template is="dom-if" if="{{selectedCard}}">
                <p>In the box below enter the <a href="#">Check Digits</a> on the reverse of your payment card and click Buy.</p>
                <p4m-card id="card" selected-card-id={{selectedCard.Id}} on-cvv="onCvv" show-actions="false" show-toggle-btn="false" show-cvv="true" card-data="{{selectedCard}}"></p4m-card>
            </template>
            <template is="dom-if" if="{{_noCardSelected}}">
                You have not yet selected a payment method. <a on-click="requestPaymentMethod">Click here to select one.</a>
            </template>
                     
            <div id="p4mBuyNowButton" on-tap="buyNow" class="p4m-button p4m-button-active">{{buttonText}}</div>
            <div id="p4mPaypalButton" on-tap="buyViaPaypal" class="p4m-button p4m-button-active hidden paypal">&nbsp;{{paypalText}}</div>
            <p class="p4m-error">{{errorMsg}}</p>   
      
        </div>
        <p4m-overlay id="overlay" with-backdrop></p4m-overlay>
    </template>

    <style> 

        #p4mPurchaseContainer {
            _display: flex;
            _flex-direction: row;
            margin: 10px;
        }
        .hidden {
            display: none;
        }
        --iron-overlay-backdrop-opacity {
            opacity: 0.9;
        }
        .p4m-error {
            color: red;
            font-weight: 500;
        }
        #p4BuyNowButton.disabled {
            cursor: not-allowed;
        }

        #p4mPaypalButton {
            background-image: url(https://www.paypalobjects.com/webstatic/en_US/i/buttons/PP_logo_h_100x26.png);
            background-color: #E0E0E0;
            background-repeat: no-repeat;
            background-position: center; 

        }

        #p4mPaypalButton:hover {
            background-color: rgba(128, 184, 128, 1.0);
        }


    </style>

    <script>
        var States = {
            CVV_NEEDED: 0,
            NOT_PURCHASED: 1,
            PURCHASING: 2,
            FAILED_PURCHASE: 3,
            PURCHASED: 4
        }
    //
        Polymer({
            is: "p4m-purchase",

            properties: {
                cartData: {
                    type: Object,
                    notify: true,
                    observer: "onCartDataChange"
                },
                selectedCard: {
                    type: Object,
                    value: null,
                    notify: true
                },

                usePaypal: {
                    type: Boolean,
                    value: false
                },
                paypalText: {
                    type: String,
                    value: ""
                },

                btnMsgNotPurchased: {
                    type: String,
                    value: "Buy now"
                },
                btnMsgNeedCvv: {
                    type: String,
                    value: "Buy now"
                },
                btnMsgBuying: {
                    type: String,
                    value: "Please wait"
                },
                btnMsgComplete: {
                    type: String,
                    value: "Purchase complete"
                },
                btnMsgNotValid: {
                    type: String,
                    value: "Cart empty"
                },
                btnMsgFailed: {
                    type: String,
                    value: "Try again"
                },
                msgFailedPayment: {
                    type: String,
                    value: "Something went wrong. Please try again."
                },
                errorMsg: {
                    type: String
                },
                redirectUrl: {
                    type: String
                },
                _topClass: {
                    type: String,
                    value: "active"
                },
                _state: {
                    type: String,
                    notify: true
                },
                _noCardSelected: {
                    type: Object,
                    value: true
                }
 
            },
            observers: [
                "onCartDataChange(cartData.*)",
                "onStateChange(_state)",
                "onCardSelected(selectedCard)"
            ],

            ready: function ()
            {
                this.load();
            },

            onCvv: function (e) {
                var card = this.$$('#card');
                if (!card || !card.cvv || card.cvv === "") {
                    this._state = States.CVV_NEEDED;
                }
                else {
                    this._state = States.NOT_PURCHASED;
                }
            },

            onStateChange: function () {
                this.updateUi();
            },

            onCartDataChange: function () {
                //this.updateUi();
            },

            buyNow: function () {
                this.errorMsg = "";
                if (this._state === States.NOT_PURCHASED || this._state === States.FAILED_PURCHASE) {
                    this._state = States.PURCHASING;
                    this.$.localApi.call('purchase', { cartId: this.cartData.Id, cvv: this.selectedCard.cvv, cartTotal: this.cartData.Total }, null, this.onPurchase.bind(this));
                }
            },

            buyViaPaypal: function () {
                if (this._state === States.NOT_PURCHASED || this._state === States.FAILED_PURCHASE || this._state === States.CVV_NEEDED) {
                    this._state = States.PURCHASING;
                    this.$.localApi.call('paypalSetup', { cartId: this.cartData.Id, cartTotal: this.cartData.Total }, null, this.onPaypalSetup.bind(this));
                }
            },

            load: function () {
                //Check to see if the user is logged in
                var token = this.$.p4mTokenCookie.readCookie();
                this._loggedIn = token !== "";
                this._state = States.CVV_NEEDED;
                if (this.usePaypal)
                    this.$.p4mPaypalButton.classList.remove("hidden");
            },

            onPurchase: function (e) {
                console.log('onPurchase', e);
                if (e.Success == false) {
                    this.errorMsg = this.msgFailedPayment;
                    this._state = States.FAILED_PURCHASE;
                }
                else {
                    // check we need to launch the 3D Secure popup
                    if (e.ACSUrl && e.ACSUrl !== '') {
                        this.launch3DSecure(e.ACSUrl, e.PaReq, e.ACSResponseUrl, e.P4MData);
                    }
                    else {
                        this._state = States.PURCHASED;
                        if (e.RedirectUrl) {
                            window.location.href = e.RedirectUrl;
                        }
                        else if (this.redirectUrl) {
                            window.location.href = this.redirectUrl;
                        }
                    }
                }
            },

            paypalUrl: "https://www.sandbox.paypal.com/cgi-bin/webscr?cmd=_express-checkout&useraction=commit&token=",

            onPaypalSetup: function (e) {
                if (e.Success == false) {
                    this.errorMsg = this.msgFailedPayment;
                    var card = this.$$('#card');
                    if (!card || !card.cvv || card.cvv === "") {
                        this._state = States.CVV_NEEDED;
                    }
                    else {
                        this._state = States.FAILED_PURCHASE;
                    }
                }
                else {
                    // we have a token from PP so now we can launch PP in a popup
                    this.openPopup(this.paypalUrl + e.Token, "paypalWindow", 650, 750);
                }
            },

            launch3DSecure: function (ACSUrl, PaReq, redirectUrl, p4mData) {
                // create a form that will post the values to the ACS and show the result in a popup
                var form = document.createElement("form");
                form.setAttribute("method", "post");
                form.setAttribute("action", ACSUrl);
                form.setAttribute("target", "p4m3DSecurePopup");

                var PaReqField = document.createElement("input");
                PaReqField.setAttribute("type", "hidden");
                PaReqField.setAttribute("name", "PaReq");
                PaReqField.setAttribute("value", PaReq);
                form.appendChild(PaReqField);

                var TermUrlField = document.createElement("input");
                TermUrlField.setAttribute("type", "hidden");
                TermUrlField.setAttribute("name", "TermUrl");
                TermUrlField.setAttribute("value", redirectUrl);
                form.appendChild(TermUrlField);

                var MDField = document.createElement("input");
                MDField.setAttribute("type", "hidden");
                MDField.setAttribute("name", "MD");
                MDField.setAttribute("value", p4mData);
                form.appendChild(MDField);

                // add the form to THIS window
                document.body.appendChild(form);

                // open the popup
                this.openPopup('', 'p4m3DSecurePopup', 650, 750);
                // submit the form from this window into the popup
                form.submit();
                // remove the form from this window
                form.remove();
            },

            openPopup: function(url, id, w, h) {
                // open the popup
                var left = (screen.width / 2) - (w / 2);
                var top = (screen.height / 2) - (h / 2);
                window.open(url, id, 'toolbar=no, location=no, directories=no, status=no, menubar=yes, copyhistory=no, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);
            },

            onCardSelected: function (e) {
                this.updateUi();
            },

            updateUi: function () {
                
                //If no payment methods, prompt to create one    
                if (this.selectedCard) {
                    this._isCardSelected = true;
                    this._noCardSelected = false;
                }
                else {
                    this._isCardSelected = false;
                    this._noCardSelected = true;
                }
        
                if (!this._loggedIn || !this.cartData) {                    
                    this.showAsNotValid();
                }
                else if (this._state == States.CVV_NEEDED) {
                    this.showAsCvvRequired();
                }
                else if (this._state == States.NOT_PURCHASED) {
                    this.showAsNotPurchased();
                }
                else if (this._state == States.PURCHASING) {
                    this.showAsBuying();
                }
                else if (this._state == States.PURCHASED) {
                    this.showAsCompleted();
                }
                else if (this._state == States.FAILED_PURCHASE) {
                    this.showAsFailed();
                }
            },

            setLoadingState: function(loading) {
                if (loading) {
                    this.showOverlay();                  
                    this._topClass = "loading";
                }
                else {
                    this.hideOverlay();

                    this._topClass = "active";
                }
            },

            showAsNotPurchased: function() {
                this.buttonText = this.btnMsgNotPurchased;
                this.$.p4mBuyNowButton.classList.add('p4m-button-active');
                this.$.p4mBuyNowButton.classList.remove('disabled');
                this.$.p4mPaypalButton.classList.add('p4m-button-active');
                this.$.p4mPaypalButton.classList.remove('disabled');
                this.setLoadingState(false);
                this.topClass = "active";
            },

            showAsNotValid: function () {
                this.buttonText = this.btnMsgNotValid; //"Cart empty";
                this.$.p4mBuyNowButton.classList.remove('p4m-button-active');
                this.$.p4mBuyNowButton.classList.add('disabled');
                this.$.p4mPaypalButton.classList.remove('p4m-button-active');
                this.$.p4mPaypalButton.classList.add('disabled');
                this.setLoadingState(false);
                this.topClass = "invalid";
            },

            showAsCvvRequired: function() {
                this.buttonText = this.btnMsgNeedCvv; //"Enter CVV";
                this.$.p4mBuyNowButton.classList.remove('p4m-button-active');
                this.$.p4mBuyNowButton.classList.add('disabled');
                this.$.p4mPaypalButton.classList.add('p4m-button-active');
                this.$.p4mPaypalButton.classList.remove('disabled');
                this.setLoadingState(false);
                this.topClass = "invalid";
                this._state = States.CVV_NEEDED;
                var card = this.$$('#card');
                if (card) {
                    card.updateUi();
                }
            },

            showAsBuying: function () {
                this.buttonText = this.btnMsgBuying;//"Please wait...";
                this.$.p4mBuyNowButton.classList.remove('p4m-button-active');
                this.$.p4mBuyNowButton.classList.add('disabled');
                this.$.p4mPaypalButton.classList.remove('p4m-button-active');
                this.$.p4mPaypalButton.classList.add('disabled');
                this.setLoadingState(true);
                this.topClass = "buying";
            },

            showAsCompleted: function () {
                this.buttonText = this.btnMsgComplete; //"Purchase complete";
                this.$.p4mBuyNowButton.classList.remove('p4m-button-active');
                this.$.p4mBuyNowButton.classList.add('disabled');
                this.$.p4mPaypalButton.classList.remove('p4m-button-active');
                this.$.p4mPaypalButton.classList.add('disabled');
                this.setLoadingState(false);
                this.topClass = "complete";
            },

            showAsFailed: function () {
                this.buttonText = this.btnMsgFailed;
                this.$.p4mBuyNowButton.classList.add('p4m-button-active');
                this.$.p4mBuyNowButton.classList.remove('disabled');
                this.$.p4mPaypalButton.classList.add('p4m-button-active');
                this.$.p4mPaypalButton.classList.remove('disabled');
                this.setLoadingState(false);
                this.topClass = "failed";
            },

            showOverlay: function() {
                this.$.overlay.open();
            },

            hideOverlay: function () {
                this.$.overlay.close();
            },

            requestPaymentMethod: function () {
                this.fire('request-payment-method');
            }
        });
    </script>
</dom-module>