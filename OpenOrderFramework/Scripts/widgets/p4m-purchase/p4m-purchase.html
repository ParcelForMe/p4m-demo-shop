<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../../Lib/paper-spinner/paper-spinner.html" />


<dom-module id="p4m-purchase">

    <template>
        <div id="p4mPurchaseContainer" class$="{{_topClass}}">
            <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
            <polymer-cookie id="p4mAvatarCookie" name="p4mAvatarUrl"></polymer-cookie>
            <polymer-cookie id="p4mGivenNameCookie" name="p4mGivenName"></polymer-cookie>
            <p4m-api id="localApi" is-local="true"></p4m-api>
            <paper-spinner id="spinner"></paper-spinner>         
            <button id="p4mBuyNowBtn" on-tap="buyNow">Buy Now</button>
        </div>
    </template>

    <style>

        #p4m-purchase-container {
            display: flex;
            flex-direction: row;
        }
        #spinner {
            width: 50px;
            height: 50px;
        }
        .hidden {
            display: none;
        }
    </style>

    <script>
    //
        Polymer({
            is: "p4m-purchase",

            properties: {
                cartData: {
                    type: Object,
                    notify: true,
                    observer: "onCartDataChange"
                },
                changes: {
                    type: Object,
                    value: {}
                }
            },
            observers: [
                "onCartDataChange(cartData.*)"
            ],

            ready: function()
            {
                this.load();
            },

            buyNow: function () {
                this.showAsBuying();
                this.$.localApi.call('purchase', { cartId: this.cartData.Id, cvv: '123' }, null, this.onPurchase.bind(this));
            },

            load: function () {
                //Check to see if the user is logged in
                var token = this.$.p4mTokenCookie.readCookie();
                this._loggedIn = token !== "";
                this.checkEnabled();
            },

            onCartDataChange: function (e) {
                this.checkEnabled();
            },

            onPurchase: function (e) {
                this.showAsCompleted();
                alert("Purchased");
                this.checkEnabled(true);
            },

            checkEnabled: function (disable) {
                this.$.p4mBuyNowBtn.disabled = disable || !this._loggedIn || !this.cartData;
            },

            showAsCompleted: function () {
                this.$.p4mBuyNowBtn.firstChild.data = "Purchase complete";
                this.$.spinner.active = false;
                this.$.spinner.classList.add('hidden');
                this.$.p4mPurchaseContainer.classList.remove('loading');
            },

            showAsBuying: function () {
                this.$.p4mBuyNowBtn.firstChild.data = "Please wait...";
                this.checkEnabled(true);
                this.$.spinner.active = true;
                this.$.spinner.classList.remove('hidden');
                this.$.p4mPurchaseContainer.classList.add('loading');
            }

        });
    </script>
</dom-module>