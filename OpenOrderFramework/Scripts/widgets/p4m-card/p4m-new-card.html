<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/paper-spinner/paper-spinner.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />

<dom-module id="p4m-new-card">

    <template>
        <p4m-api id="api" ssl="true" host-base-domain="parcelfor.me" host-type="local" version="v2"></p4m-api>
        <div id="container" class="loading">
            <p>Your card details are stored securely by our fully PCI compliant payment service. <a href="#">Read more</a></p>
            <paper-spinner id="spinner" active="true"></paper-spinner>
            <iframe id="paymentIframe" name="realexIFrame" on-load="onFrameLoaded" height="609"></iframe>
            <form id="realexForm" method="POST" action="https://hpp.sandbox.realexpayments.com/pay" target="realexIFrame">
                <input type="hidden" name="TIMESTAMP" value="{{cardTimestamp}}" />
                <input type="hidden" name="MERCHANT_ID" value="{{cardMerchantId}}" />
                <input type="hidden" name="ACCOUNT" value="internet" />
                <input type="hidden" name="ORDER_ID" value="{{newCardId}}" />
                <input type="hidden" name="AMOUNT" value="0">
                <input type="hidden" name="CURRENCY" value="{{currency}}" />
                <input type="hidden" name="SHA1HASH" value="{{cardHash}}" />
                <input type="hidden" name="AUTO_SETTLE_FLAG" value="1" />
                <input type="hidden" name="HPP_VERSION" value="2" />
                <!-- Card Storage Fields -->
                <input type="hidden" name="CARD_STORAGE_ENABLE" value="1" />
                <input type="hidden" name="OFFER_SAVE_CARD" value="0" />
                <input type="hidden" name="PAYER_EXIST" value="{{payerExist}}" />
                <input type="hidden" name="PAYER_REF" value="{{consumerData.Id}}" />
                <input type="hidden" name="PMT_REF" value="{{newCardId}}" />
                <input type="hidden" name="VALIDATE_CARD_ONLY" value="1" />
                <!-- End Card Storage Fields -->
                <input type="hidden" name="MERCHANT_RESPONSE_URL" value="{{responseUrl}}" />
                <input type="hidden" name="PAYER_LOCALE" value="{{consumerData.Locale}}" />
                <input type="hidden" name="P4M_SOURCE" value="web" />
                <input type="hidden" name="CARD_PAYMENT_BUTTON" value="Store Card" />
            </form>
        </div>

    </template>

    <style>
        #container {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .card-actions {
            display: flex;
            flex-direction: row;
        }

        .card-actions a {
            color: black;
        }


        #container.loading #paymentIframe {
            visibility: hidden;
        }
 
        #spinner {
            display: none;
            width: 100px;
            height: 100px;
            position: absolute;
            top: 130px;
            left: 250px;
            margin: auto;
        }

        #container.loading #spinner {
            display: block;
        }

    </style>

    <script>

        Polymer({
            is: "p4m-new-card",

            properties: {
                responseUrl: {
                    type: String,
                    value: "https://local.parcelfor.me:443/realex/v2/cardTokenResponse"
                },
                consumerData: {
                    type: Object,
                    notify: true,
                },
                cardHash: {
                    type: String,
                    notify: true,
                },
                cardTimestamp: {
                    type: String,
                    notify: true,
                },
                cardMerchantId: {
                    type: String,
                    notify: true,
                },
                currency: {
                    type: String,
                    value: "GBP"    // never need to change this because we're only storing a card
                },
                payerExist: {
                    type: String,
                    value: "0",
                    notify: true,
                },
                payerLocale: {
                    type: String,
                    notify: true,
                },
                newCardId: {
                    type: String,
                    notify: true,
                }
            },

            observers: [
               "onConsumerData(consumerData)"
            ],

            ready: function()
            {
               
            },

            onConsumerData: function (consumer) {
                console.log("New card got consumer: ", consumer);
                this.set('payerExist',(consumer.PaymentMethods.length > 0) ? "1" : "0");
            },

            loadRealexForm: function() {
                this.newCardId = Math.floor(Math.random() * 9999999) + "-" + Math.floor(Math.random() * 9999999);
                var d = new Date();
                var timeStampStr = (d.getFullYear().toString() + '-' + (d.getMonth() + 1 < 10 ? '0' : '') + (d.getMonth() + 1).toString() + '-' + d.getDate().toString() + "T" + (d.getHours() + 1 < 10 ? '0' : '') + d.getHours().toString() + ':' + (d.getMinutes() + 1 < 10 ? '0' : '') + d.getMinutes().toString() + ':' + (d.getSeconds() + 1 < 10 ? '0' : '') + d.getSeconds().toString());

                this.$.api.call('cardTokenHash',
                {
                    timestamp: timeStampStr,
                    orderId: this.newCardId,
                    currency: this.currency,
                    payMethodId: this.newCardId,
                    amount: 0
                }, null, this.onCardHash.bind(this));

            },

            onCardHash: function (hashResponse) {
                //We have received the hash data, now fill in the form and post  
                console.log("Received card hash. Posting form...", hashResponse);
                this.set('cardMerchantId', hashResponse.MerchantId);
                this.set('cardHash', hashResponse.Hash);
                this.set('cardTimestamp', hashResponse.Timestamp);
                this._requestedForm = true;
                this.$.realexForm.submit();
                window.addEventListener("message", this.receiveMessage, false);
            },

            onFrameLoaded: function () {
                if (this._requestedForm) {
                    console.log("FRAME LOADED");
                    this.$.container.classList.remove('loading');
                }

            },

            receiveMessage: function (event)
            {
                alert("got it");
            }
        });
    </script>
</dom-module>
