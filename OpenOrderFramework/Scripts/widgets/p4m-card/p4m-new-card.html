<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/paper-spinner/paper-spinner.html" />

<dom-module id="p4m-new-card">

    <template>
        <div id="container" class="loading">
            
            <p>Your card details are stored securely by our fully PCI compliant payment service. <a href="#">Read more</a></p>
            <paper-spinner id="spinner" active="true"></paper-spinner>
            <iframe id="paymentIframe" name="realexIFrame" on-load="onFrameLoaded" height="609"></iframe>
            <form id="realexForm" method="POST" action="https://hpp.sandbox.realexpayments.com/pay" target="realexIFrame">
                <input type="hidden" name="TIMESTAMP" value="{{cardTimestamp}}" />
                <input type="hidden" name="MERCHANT_ID" value="{{cardMerchantId}}" />
                <input type="hidden" name="ACCOUNT" value="internet" />
                <input type="hidden" name="ORDER_ID" value="{{newCardId}}" />
                <!--<input type="hidden" name="AMOUNT" value="1001">-->
                <input type="hidden" name="CURRENCY" value="{{currency}}" />
                <input type="hidden" name="SHA1HASH" value="{{cardHash}}" />
                <input type="hidden" name="AUTO_SETTLE_FLAG" value="1" />
                <input type="hidden" name="HPP_VERSION" value="2" />
                <!-- Card Storage Fields -->
                <input type="hidden" name="CARD_STORAGE_ENABLE" value="1" />
                <input type="hidden" name="OFFER_SAVE_CARD" value="0" />
                <input type="hidden" name="PAYER_EXIST" value="{{payerExist}}" />
                <input type="hidden" name="PAYER_REF" value="{{consumerData.Id}}" />
                <input type="hidden" name="PMT_REF" value="{{newCardId}}" />
                <input type="hidden" name="VALIDATE_CARD_ONLY" value="1" />
                <!-- End Card Storage Fields -->
                <input type="hidden" name="MERCHANT_RESPONSE_URL" value="{{responseUrl}}" />
                <input type="hidden" name="PAYER_LOCALE" value="{{consumerData.Locale}}" />
                <input type="hidden" name="CARD_PAYMENT_BUTTON" value="Use Card" />
            </form>
            

        </div>

    </template>

    <style>
        #container {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .card-actions {
            display: flex;
            flex-direction: row;
        }

        .card-actions a {
            color: black;
        }


        #container.loading #paymentIframe {
            visibility: hidden;
        }
 
        #spinner {
            display: none;
            width: 100px;
            height: 100px;
            position: absolute;
            top: 130px;
            left: 250px;
            margin: auto;
        }

        #container.loading #spinner {
            display: block;
        }

    </style>

    <script>

        Polymer({
            is: "p4m-new-card",

            properties: {
                responseUrl: {
                    type: String,
                    value: "https://dev.parcelfor.me:44321/api/v2/cardTokenResponse"
                },
                cardHash: {
                    type: String,
                    notify: true,
                    observer: "onCardHash"
                },
                cardTimestamp: {
                    type: String,
                    notify: true
                },
                cardMerchantId: {
                    type: String,
                    notify: true,
                    observer: "onCardMerchantId"
                },
                currency: {
                    type: String,
                    notify: true,
                    value: "GBP"
                },
                payerExist: {
                    type: String,
                    notify: true,
                    value: "0"
                },
                newCardId: {
                    type: String
                }
            },

            observers: [
               // "onCardHash(cardHash)"
            ],

            ready: function()
            {
               
            },

            onCardHash: function () {
                //We have received the hash data, now fill in the form and post  
                console.log("Received card hash. Posting form...");
                this._requestedForm = true;
                this.$.realexForm.submit();
            },

            onFrameLoaded: function () {
                if (this._requestedForm) {
                    console.log("FRAME LOADED");
                    this.$.container.classList.remove('loading');
                }

            },

            onCardMerchantId: function () {
                console.log("Received card merchant");
            }


        });
    </script>
</dom-module>
