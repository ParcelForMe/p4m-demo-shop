<link rel="import" href="../../Lib/polymer/polymer.html" />
<script src="../../Lib/momentjs/min/moment.min.js"></script>

<dom-module id="p4m-order-text">

    <template>
        <div id="container">
            Thanks for ordering from us <span class="p4m-label">{{consumerData.GivenName}}</span>.

            <template is="dom-if" if="{{!cartData.AddressId}}">
                You have not yet chosen an address. <a on-click="requestAddress">Click here to choose one.</a>
            </template>

            <template is="dom-if" if="{{cartData.AddressId}}">
                We'll deliver your order to your {{addressTypeStr}}:
                <span class="p4m-label">{{deliveryAddressStr}}</span>{{deliveryDatePrefixStr}}
                <span class="p4m-label">{{deliveryDateStr}}.</span> Your order will be sent via
                <span class="p4m-label">{{deliveryMethodStr}} delivery</span>.
            </template>
            <template is="dom-if" if="{{isLoading}}">
                <p>Getting your delivery details now...</p>
            </template>
        </div>
    </template>

    <style>
        #container {
            margin: 10px 18px 10px 18px;
        }

    </style>   

    <script>
    //
        Polymer({
            is: "p4m-order-text",

            properties: {
                consumerData: {
                    type: Object
                },
                cartData: {
                    type: Object
                },
                addressTypeStr: {
                    type: String,
                    value: "address"
                },
                deliveryAddressStr: {
                    type: String,
                    value: "Please select an address"
                },
                deliveryDateStr: {
                    type: String
                },
                deliveryMethodStr: {
                    type: String
                },
                isLoading: {
                    type: Object,
                    value: true
                }

            },

            observers: [
                "updateUi(consumerData.*)",
                "updateUi(cartData.*)"
            ],

            ready: function()
            {
                this.updateUi();
            },


            updateUi: function()
            {
                if (this.cartData && this.consumerData) {
                    this.isLoading = false;
                    var deliveryAddr = this._addressById(this.cartData.AddressId);
                    this.deliveryAddressStr = this._addressToStr(deliveryAddr);
                    this.addressTypeStr = this._addressType(deliveryAddr);
                    this.deliveryDatePrefixStr = this._expectedDeliveryDatePrefixStr(this.cartData.ExpDeliveryDate);
                    this.deliveryDateStr = this._expectedDeliveryDateStr(this.cartData.ExpDeliveryDate);
                    this.deliveryMethodStr = this.cartData.ServiceName;

                }
                else {
                    this.isLoading = true;
                }
            },

            _addressById: function(id) {
                var foundAddress = null;
                if (this.consumerData && this.consumerData.Addresses && this.consumerData.Addresses.length) {
                    for (var i = 0; i < this.consumerData.Addresses.length; i++) {
                        var address = this.consumerData.Addresses[i];
                        if (address.Id == this.cartData.AddressId) {
                            foundAddress = address;
                            break;
                        }
                    }
                }

                return foundAddress;            
            },

            _addressToStr: function (address) {
                if (address) {
                    return address.Street1;// + " " + address.Street2 + " in " + (address.City || address.PostCode);
                }
                else {
                    return "";
                }
                
            },

            _addressType: function (address) {
                if (address && address.AddressType) {
                    if (address.AddressType === "Collect") {
                        return "preferred collection point";
                    }
                    else {
                        return "preferred delivery address";
                    }
                }
            },

           
            _expectedDeliveryDateStr: function (dateStr) {
                if (dateStr) {                                   
                    return moment(new Date(dateStr)).format('ddd Do MMM YYYY');
                }
                else {
                    return "Please select a delivery method to continue";
                }
                
            },

            _expectedDeliveryDatePrefixStr: function (dateStr) {
                if (dateStr) {
                    return " by ";
                }
                else {
                    return ". ";
                }

            },

            _hasDeliveryDetails: function () {
                console.log('_hasDeliveryDetails');
                return (this.cartData && this.cartData.ExpDeliveryDate && this.cartData.AddressId);
            },

            requestAddress: function () {
                this.fire('request-address');
            }



        });
    </script>
</dom-module>
