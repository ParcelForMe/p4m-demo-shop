<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/iron-ajax/iron-ajax.html" />
<link rel="import" href="../../Lib/polymer-cookie/polymer-cookie.html" />

<dom-module id="local-api">

    <template>
        <iron-ajax
            id="apiAjax"
            method="GET"
            handle-as="json"
            content-type="application/json"
            on-response="_handleResponse"
            debounce-duration="300">
        </iron-ajax>
        <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
    </template>

    <script>
        var apiEndpoints = {
            "localLogin": {
                "stub": "localLogin",
                "method": "GET",
                "params": [{
                    "name": "currentPage",
                    "required": true
                }]
            },
            "getP4MCart": {
                "stub": "getP4MCart",
                "method": "GET"
            },
            "shippingSelector": {
                "stub": "shippingSelector",
                "method": "GET"
            },
            "applyDiscountCode": {
                "stub": "applyDiscountCode/{discountCode}",
                "method": "GET",
                "params": [
                    {
                        "name": "discountCode",
                        "required": true
                    }
                ]
            },
            "itemQtyChanged": {
                "stub": "itemQtyChanged",
                "method": "POST",
                "params": []
            },
        };


        Polymer({
            is: "local-api",

            properties: {
                _endPoints: {
                    type: Object,
                    value: apiEndpoints
                }
            },
            listeners: {

            },

            ready: function() {
               
            },

            _baseUrl: function() {
                return "//" + window.location.host + "/";
            },

            call: function (name, params, data, callback) {
                var endPoint = this._endPoints[name]
                if (!endPoint) {
                    console.error("Invalid endpoint:", name);
                }
                else
                {
                    var apiRequest = {
                        "endPoint": endPoint,
                        "data": data,
                        "params": params
                    }
                    this._prepareApiCall(apiRequest, callback);
                    this.$.apiAjax.generateRequest();
                }

            },

            _prepareApiCall: function (apiRequest, callback) {
                if (this._validateApiRequest(apiRequest)) {
                    var url = this._baseUrl() + apiRequest.endPoint.stub;
                    this.$.apiAjax.params = {};
                    if (apiRequest.params)
                    {
                        //Swap in parameters if specified in the URL, otherwise add as query params
                        for (var paramName in apiRequest.params) {
                           
                            //If this parameter is present in the URL
                            var paramValue = apiRequest.params[paramName];
                            var subKey = "{" + paramName + "}";
                            if (url.indexOf(subKey) > -1) {
                                url = url.replace(subKey, paramValue);
                            }
                            else {
                                //Query params
                                this.$.apiAjax.params[paramName] = paramValue;                             
                            }
                        };
                    }
                    this.$.apiAjax.url = url;
                    this.$.apiAjax.method = apiRequest.endPoint.method;
                    if (apiRequest.endPoint.method === "POST") {
                        this.$.apiAjax.body = apiRequest.data;
                    }
                    if (this._callback) {
                        console.warn("Making new API call before previous call has completed");
                    }
                    this._callback = callback;
                    this._currentCall = apiRequest.endPoint.stub;
                }
            },

            _validateApiRequest: function (apiRequest) {

                //=== PARAMETER VALIDATION

                //Missing required params  
                var missingParams = getMissingRequiredItems(apiRequest.params, apiRequest.endPoint.params);
                missingParams.forEach(function (p) {
                    console.error("Missing required parameter: " + p.name);
                });                 

                //=== FIELD VALIDATION

                //Missing required fields
                var missingFields = getMissingRequiredItems(apiRequest.fields, apiRequest.endPoint.fields);
                missingFields.forEach(function (f) {
                    console.error("Missing required field: " + f.name);
                });

                //Return false if any missing params or fields
                return !((missingParams.length || missingFields.length));
            },

            _handleResponse: function(e) {
                if (this._callback) {
                    this._callback(e.detail.response);
                }
                this._callback = null;
                this.fire("p4m_local_" + this._currentCall, e.detail.response, true);
                this._currentCall = null;
            }

        });

        function getMissingRequiredItems(obj, templateItems) {
            return (templateItems||[])
            .filter(function (i) { //Return list of required items
                return i.required
            })
            .filter(function (i) { //Of those, return those missing from the obj
                return (typeof(obj[i.name]) === "undefined")
            });
        }
    </script>
</dom-module>