<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/iron-ajax/iron-ajax.html" />
<link rel="import" href="../../Lib/polymer-cookie/polymer-cookie.html" />

<dom-module id="p4m-api">

    <template>
        <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
    </template>

    <script>
        var apiEndpoints = {};
        apiEndpoints.v2 = {
            "consumer": {
                "stub": "consumer",
                "method": "GET",
                "params": []
            },
            "consumerExtras": {
                "stub": "consumerExtras",
                "method": "POST",
            },
            "cart": {
                "stub": "cart/{cartId}",
                "method": "GET",
                "params": [
                    {
                        "name": "cartId",
                        "required": true
                    }
                ]
            },
            "currentCart": {
                "stub": "currentCart/{sessionId}",
                "method": "GET",
                "params": [
                    {
                        "name": "sessionId",
                        "required": true
                    }
                ]
            },
            "postCart": {
                "stub": "cart",
                "method": "POST",
            },
            "postAddress": {
                "stub": "address",
                "method": "POST"
            },

            "cardTokenHash": {
                "stub": "cardTokenHash",
                "params": [
                    {
                        "name": "timestamp",
                        "required": true
                    },
                    {
                        "name": "orderId",
                        "required": true
                    },
                    {
                        "name": "currency",
                        "required": true
                    },
                    {
                        "name": "payMethodId",
                        "required": true
                    }
                ],
                "method": "GET"
            },
        };
        apiEndpoints.local = {
            "localLogin": {
                "stub": "localLogin",
                "method": "GET",
                "params": [{
                    "name": "currentPage",
                    "required": true
                }]
            },
            "isLocallyLoggedIn": {
                "stub": "isLocallyLoggedIn",
                "method": "GET"
            },
            "getP4MCart": {
                "stub": "getP4MCart",
                "method": "GET"
            },
            "shippingSelector": {
                "stub": "shippingSelector",
                "method": "GET"
            },
            "applyDiscountCode": {
                "stub": "applyDiscountCode/{discountCode}",
                "method": "GET",
                "params": [
                    {
                        "name": "discountCode",
                        "required": true
                    }
                ]
            },
            "itemQtyChanged": {
                "stub": "itemQtyChanged",
                "method": "POST",
                "params": []
            },
            "purchase": {
                "stub": "purchase/{cartId}/{cvv}",
                "method": "GET",
                "params": [
                    {
                        "name": "cartId",
                        "required": true
                    },
                    {
                        "name": "cvv",
                        "required": true
                    },
                ]
            }
        };


        Polymer({
            is: "p4m-api",

            properties: {
                ssl: {
                    type: Object,
                    value: true
                },
                hostBaseDomain: {
                    type: String,
                    value: "parcelfor.me"
                },
                hostType: {
                    type: String,
                    value: "dev" //local, dev, test, live
                },
                port: {
                    type: Number,
                    value: 44321
                },
                version: {
                    type: String,
                    value: "v2"
                    //value: "https://local.parcelfor.me:44321/api/v2/"
                },
                consumerToken: {
                    type: String
                },
                isLocal: { //Make local-api a descendant of p4m-api
                    type: Object,
                    value: false
                },
                _endPoints: {
                    type: Object,
                    value: apiEndpoints
                },
                _queue: {
                    type: Array,
                    value: []
                }
            },
            listeners: {

            },

            ready: function () {
                if (this.isLocal) {
                    this.version = "local";
                }             
            },

            _baseUrl: function () {
                if (this.isLocal) {                   
                    return "//" + window.location.host + "/";                   
                }
                else {
                    return (this.ssl ? "https" : "http") + "://" + this.hostType + "." + this.hostBaseDomain + ":" + this.port + "/api/" + this.version + "/";
                }               
            },

            call: function (name, params, data, callback) {

                var endPoint = this._endPoints[this.version][name]
                if (!endPoint) {
                    console.error("Invalid endpoint:", name);
                }
                else
                {
                    var apiRequest = {
                        "endPoint": endPoint,
                        "data": data,
                        "params": params
                    }
                    if (typeof (callback) == "undefined") {
                        callback = function () { };
                    }
                    this._performApiCall(apiRequest, callback);
                }

            },

            _processNextRequest: function () {

                var request = this._queue.pop();
                if (request) {
                    this._performApiCall(request.apiRequest, request.callback);
                }
                else {
                    console.log("Finished queue");
                }
         
            },

            _performApiCall: function (apiRequest, callback) {
                
                if (this._validateApiRequest(apiRequest)) {
                    
                    var httpRequest = new XMLHttpRequest();
                    var queryParams = {};
                    var url = this._baseUrl() + apiRequest.endPoint.stub;
                    var queryParamCount = 0;

                    //=== Make URL
                    if (apiRequest.params)
                    {
                        //Swap in parameters if specified in the URL, otherwise add as query params
                        for (var paramName in apiRequest.params) {
                            
                            //If this parameter is present in the URL
                            var paramValue = apiRequest.params[paramName];
                            var subKey = "{" + paramName + "}";
                            if (url.indexOf(subKey) > -1) {
                                url = url.replace(subKey, paramValue);
                            }
                            else {
                                //Query params
                                if (queryParamCount === 0) {
                                    url += "?";
                                }
                                else if (queryParamCount > 0) {
                                    url += "&";
                                }
                                url += paramName + "=" + paramValue;    
                                queryParamCount ++;
                            }
                        };
                    }
                    httpRequest.open(apiRequest.endPoint.method, url, true);

                    var intermediateCallback = this._handleResponse.bind(this, apiRequest, callback);

                    if (!this.consumerToken) {
                        this.consumerToken = this.$.p4mTokenCookie.readCookie();
                    }
                    httpRequest.setRequestHeader('Authorization', 'Bearer ' + this.consumerToken);
                    httpRequest.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                    httpRequest.onreadystatechange = (function () {
                        if (httpRequest.readyState === XMLHttpRequest.DONE) {
                            intermediateCallback(JSON.parse(httpRequest.responseText));
                        }
                    });
                    if (apiRequest.data) {
                        httpRequest.send(JSON.stringify(apiRequest.data));
                    }
                    else {
                        httpRequest.send();
                    }  
                }
            },

            _validateApiRequest: function (apiRequest) {

                //=== PARAMETER VALIDATION

                //Missing required params  
                var missingParams = getMissingRequiredItems(apiRequest.params, apiRequest.endPoint.params);
                missingParams.forEach(function (p) {
                    console.error("Missing required parameter: " + p.name);
                });                 

                //=== FIELD VALIDATION

                //Missing required fields
                var missingFields = getMissingRequiredItems(apiRequest.fields, apiRequest.endPoint.fields);
                missingFields.forEach(function (f) {
                    console.error("Missing required field: " + f.name);
                });

                //Return false if any missing params or fields
                return !((missingParams.length || missingFields.length));
            },

            _handleResponse: function (apiRequest, finalCallback, responseData) {
                this.fire("p4m_" + apiRequest.endPoint.stub, responseData, true);
                finalCallback(responseData);           
            }

        });

        function getMissingRequiredItems(obj, templateItems) {
            return (templateItems||[])
            .filter(function (i) { //Return list of required items
                return i.required
            })
            .filter(function (i) { //Of those, return those missing from the obj
                return (typeof(obj[i.name]) === "undefined")
            });
        }
    </script>
</dom-module>