<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/iron-collapse/iron-collapse.html" />
<link rel="import" href="../p4m-address/p4m-address.html" />

<dom-module id="p4m-address-list">

    <template>
        <div id="container">
            <a href="#" on-tap="addNewAddress">Add a new address</a>

            <template is="dom-repeat" items="{{addressListData}}" filter="filterNewOnly">
                <p4m-address address-data="{{item}}" on-canceledit="cancelAdd" cart-data="{{cartData}}" mode="edit" on-save="onAddAddress"></p4m-address>
            </template>

            <template is="dom-repeat" items="{{addressListData}}" filter="filterOldOnly">
                <p4m-address address-data="{{item}}" on-canceledit="cancelEdit" cart-data="{{cartData}}" mode="view" on-save="onUpdateAddress" on-select="onSelectAddress"></p4m-address>
            </template>

        </div>

    </template>

    <style>
        #container {
            display: flex;
            flex-direction: column;
        }

    </style>

    <script>
    //
        Polymer({
            is: "p4m-address-list",

            properties: {
                addressListData: {
                    type: Array,
                    notify: true
                },
                cartData: {
                    type: Object,
                    notify: true
                },
                newAddress: {
                    type: Object,
                    value: {},
                    notify: true
                },
                _addedNewAddress: {
                    type: Object,
                    value: false
                }
            },

            observers: [
                "onCartAddressDataChange(cartData.BillingAddressId)",
                "onCartAddressDataChange(cartData.AddressId)"
            ],

            ready: function()
            {
                
            },

            addNewAddress: function () {
               
                if (this.addressListData && !this._addedNewAddress) {
                    this._addedNewAddress = true;
                    //Add empty object to handle adding a new address
                    this.push('addressListData', this.newAddress);
                    //this.$.newAddressCollapse.opened = true;
                }
                
 
            },

            cancelAdd: function(e) {
                console.log("Cancel add address");
                this._addedNewAddress = false;
                this.pop('addressListData');

                //this.$.newAddressCollapse.opened = false;
            },

            cancelEdit: function (e) {
                // revert card to previous values
                console.log("Cancel edit address");
                //this.$.newAddressCollapse.opened = false;
            },

            onAddAddress: function(addressElement) {
                this.fire('add', addressElement.detail);
            },

            onUpdateAddress: function (addressElement) {
                this.fire('update', addressElement.detail);
            },

            onSelectAddress: function(e) {
                //this.fire('select', e.detail);
            },

            onCartAddressDataChange: function (e) {
                var i = 0;
                //console.log("Changed delivery or billing address");
                if (this.addressListData) {
                    this.addressListData.forEach((function (item) {
                        this.notifyPath('addressListData.#' + i + "._update", Math.random());
                        i++;
                    }).bind(this));
                }

                //this.notifyPath('addressData', this.addressListData);
            },

            filterNewOnly: function (e) {
                return (typeof(e.Label) === "undefined" && e.AddressType == "Address");
            },

            filterOldOnly: function (e) {
                return (typeof (e.Label) === "string" && e.AddressType == "Address");
            }

        });
    </script>
</dom-module>
