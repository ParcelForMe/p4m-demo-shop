<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/iron-collapse/iron-collapse.html" />
<link rel="import" href="../p4m-address/p4m-address.html" />

<dom-module id="p4m-address-list">

    <template>
        <div id="container">
            <a href="#" on-tap="addNewAddress">Add a new address</a>
            <iron-collapse id="newAddressCollapse">
                <template is="dom-repeat" items="{{addressListData}}" filter="filterNewOnly">
                    <p4m-address address-data="{{item}}" on-canceledit="cancelEdit" consumer-data="{{consumerData}}" mode="edit" on-save="onAddAddress"></p4m-address>
                </template>
            </iron-collapse>

            <template is="dom-repeat" items="{{addressListData}}" filter="filterOldOnly">
                <p4m-address address-data="{{item}}" consumer-data="{{consumerData}}" mode="view" on-save="onUpdateAddress" ></p4m-address>
            </template>
        </div>

    </template>

    <style>
        #container {
            display: flex;
            flex-direction: column;
        }

    </style>

    <script>
    //
        Polymer({
            is: "p4m-address-list",

            properties: {
                addressListData: {
                    type: Array,
                    notify: true
                    //observer: "onAddressDataChange"
                },
                consumerData: {
                    type: Object,
                    notify: true
                    //observer: "onConsumerDataChange"
                },
                newAddress: {
                    type: Object,
                    value: {},
                    notify: true,
                    observer: "onNewAddressChange"
                },
                _addedNewAddress: {
                    type: Object,
                    value: false
                }
            },

            observers: [
                "onAddressDataChange(addressListData.*)",
                "onConsumerPreferredAddressDataChange(consumerData.BillingAddressId)",
                "onConsumerPreferredAddressDataChange(consumerData.PrefDeliveryAddressId)"
            ],

            ready: function()
            {
                
            },

            addNewAddress: function () {
                this.$.newAddressCollapse.opened = true;
                if (this.addressListData && !this._addedNewAddress) {
                    this._addedNewAddress = true;
                    //Add empty object to handle adding a new address
                    this.push('addressListData', this.newAddress);
                }
 
            },

            cancelEdit: function(e) {
                console.log("Cancel edit");
                this.$.newAddressCollapse.opened = false;
            },

            onAddAddress: function(addressElement) {
                this.fire('add', addressElement);
            },

            onUpdateAddress: function(addressElement) {
                this.fire('update', addressElement);
            },

            onConsumerPreferredAddressDataChange: function (e) {
                var i = 0;
                console.log("Changed preferred billing address");
                if (this.addressListData) {
                    this.addressListData.forEach((function (item) {
                        this.notifyPath('addressListData.#' + i + "._update", Math.random());
                        i++;
                    }).bind(this));
                }

                //this.notifyPath('addressData', this.addressListData);
            },

            filterNewOnly: function (e) {
                return (typeof(e.Label) === "undefined");
            },

            filterOldOnly: function (e) {
                return (typeof(e.Label) === "string");
            }

        });
    </script>
</dom-module>
