<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/paper-spinner/paper-spinner.html" />

<dom-module id="p4m-order-summary">

    <template>
        <div id="p4mContainer">
            <h2>Order Summary</h2>
            <div class="p4m-table">
                <div class="p4m-row">
                    <div class="p4m-cell header-col">{{_cartItemCount}} items</div>
                    <div class="p4m-cell detail-col">{{_cartDescription}}</div>
                    <div class="p4m-cell cost-col">{{currencySymbol}}{{_cartItemsTotalPriceString}}</div>
                </div>
                <div class="p4m-row">
                    <div class="p4m-cell header-col">Delivery</div>
                    <div class="p4m-cell detail-col">Default delivery</div>
                    <div class="p4m-cell cost-col">{{currencySymbol}}{{cartData.ShippingAmt}}</div>
                </div>
                <div class="p4m-row">
                    <div class="p4m-cell header-col">Discount</div>
                    <div class="p4m-cell detail-col">None</div>
                    <div class="p4m-cell cost-col">{{currencySymbol}}{{discount}}</div>
                </div>
                <div class="p4m-row">
                    <div class="p4m-cell header-col">Tax</div>
                    <div class="p4m-cell detail-col">Total tax</div>
                    <div class="p4m-cell cost-col">{{currencySymbol}}{{_tax}}</div>
                </div>
                <div class="p4m-row">
                    <div class="p4m-cell header-col">Total</div>
                    <div class="p4m-cell detail-col"></div>
                    <div class="p4m-cell cost-col">{{currencySymbol}}{{_total}}</div>
                </div>
            </div>
            <paper-spinner id="spinner"></paper-spinner>

        </div>
    </template>

    <style>
        #p4mContainer {
            width: 90%;
            margin: auto;
            position: relative;
        }
        #p4mContainer.loading .p4m-table .p4m-cell {
            color: #D0D0D0;
        }
        .p4m-table {
            display: flex;
            flex-direction: column;
        }
        .p4m-row {
            display: flex;
            flex-direction: row;
        }
        .p4m-row .header-col {
            color: #404040;
            width: 20%;
        }
        .p4m-row .detail-col {
            width: 60%;
        }
        .p4m-row .cost-col {
            width: 20%;          
        }
        .p4m-row .p4m-cell {
            min-width: 0;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }


        #spinner {
            width: 50px;
            height: 50px;
            position: absolute;
            top: 65px;
            left: 40%;
            margin: auto;
        }

        .hidden {
            display: none;
        }
    </style>

    <script>
    //
        Polymer({
            is: "p4m-order-summary",

            properties: {
                cartData: {
                    type: Object,
                    notify: true,
                    observer: "onCartDataModified"
                },
                currencySymbol: {
                    type: String,
                    value: '$'
                },
                _cartItemCount: {
                    type: Number,
                    notify: true,
                    value: 0
                },
                _cartItemsTotalPrice: {
                    type: Number,
                    notify: true
                },
                _cartItemsTotalPriceString: {
                    type: String
                },
                _cartDescription: {
                    type: Number,
                    notify: true,
                    value: ''
                },
                _tax: {
                    type: String
                },
                _discount: {
                    type: Number,
                    value: 0
                }
            },
            observers: [ "onCartDataModified(cartData.Items.*)"],
            ready: function()
            {
                this.update.bind(this)();
            },

            update: function () {
                if (this.cartData) {
                    this._updateItemCount();
                    this._updateCartDescription();
                    this._updateCurrencyAmounts();
                }               
            },

            _updateItemCount: function() {
                this._cartItemCount = 0;
                this._cartItemsTotalPrice = 0;
                var self = this;
                this.cartData.Items.forEach(function (item) {
                    self._cartItemCount += Number(item.Qty);
                    self._cartItemsTotalPrice += Number(item.Qty) * Number(item.Price);
                });
                self._cartItemsTotalPriceString = self._cartItemsTotalPrice.toFixed(2);
            },

            _updateCartDescription: function() {
                this._cartDescription = null;
                var self = this;
                this.cartData.Items.forEach(function (item) {
                    if (self._cartDescription) {
                        self._cartDescription += ", ";
                    }
                    else self._cartDescription = "";
                    self._cartDescription += item.Desc;
                });
            },

            _updateCurrencyAmounts: function () {
                this._tax = this.cartData.Tax.toFixed(2);
                this._total = this.cartData.Total.toFixed(2);
            },


            onCartDataModified: function (e) {
                console.log("p4m-order-summary: onCartDataModified()", e);
                this.update();
            },
         
            showAsLoaded: function () {
                this.$.spinner.active = false;
                this.$.spinner.classList.add('hidden');
                this.$.p4mContainer.classList.remove('loading');
            },

            showAsLoading: function () {
                this.$.spinner.active = true;
                this.$.spinner.classList.remove('hidden');
                this.$.p4mContainer.classList.add('loading');
            }

        });
    </script>
</dom-module>