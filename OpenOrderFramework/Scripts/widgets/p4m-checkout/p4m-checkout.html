<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/polymer-cookie/polymer-cookie.html" />
<link rel="import" href="../../Lib/paper-tabs/paper-tabs.html" />
<link rel="import" href="../../Lib/iron-pages/iron-pages.html" />

<link rel="import" href="../p4m-profile/p4m-profile.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../p4m-api/local-api.html" />
<link rel="import" href="../p4m-cart/p4m-cart.html" />
<link rel="import" href="../p4m-order-summary/p4m-order-summary.html" />

<dom-module id="p4m-checkout">

    <template>
        <p4m-api id="api" ssl="true" host-base-domain="parcelfor.me" host-type="dev" version="v2"></p4m-api>
        <local-api id="localApi"></local-api>
        <div id="container">
            <div id="topPanel" class="topPanel"><h2>Review My Order</h2><p4m-profile mode="basic"></p4m-profile></div>
            <div id="panelContainer">
                <div id="detailPanel" class="p4m-panel">
                    <paper-tabs selected="{{selectedTab}}">
                        <paper-tab>My Order</paper-tab>
                        <paper-tab>Delivery Options</paper-tab>
                        <paper-tab>Payment Options</paper-tab>
                        <paper-tab>Addresses</paper-tab>
                    </paper-tabs>
                    <iron-pages selected="{{selectedTab}}">                   
                        <iron-page>                       
                            <p4m-cart id="cart" cart-data="{{cartData}}"></p4m-cart>                         
                        </iron-page>
                        <iron-page>
                            Delivery options here
                        </iron-page>
                        <iron-page>
                            Payment options here
                        </iron-page>
                        <iron-page>
                            Addresses here
                        </iron-page>
                    </iron-pages>                 
                </div>
                <div id="summaryPanel" class="p4m-panel">
                    <link rel="import" href="../../Lib/paper-spinner/paper-spinner.html" />
                    <p4m-order-summary id="orderSummary" cart-data="{{cartData}}"></p4m-order-summary> 
                </div>

            </div>
            
        </div>

        <polymer-cookie id="sessionCookie" name="CartId"></polymer-cookie>
    </template>

    <style>
        #container {
            width: 100%;
            margin: auto;
        }
        #panelContainer {
            display: flex;
            border-radius: 5px;
            background-color: white;

        }
        .topPanel {
            width: 100%;
            background-color: #E0E0E0;
            border: none;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            padding: 20px;
        }
        .topPanel h2 {
            margin: 0px;
            letter-spacing: 3px;
            text-transform: uppercase;
            display: inline-block;
        }

        .topPanel p4m-profile {
            float: right;
            margin-top: -8px;
        }   
        .panelContainer {
            border-bottom-right-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        .p4m-panel {
            width: 50%; 
            /*height: 200px;*/
            border: none;
        }
        .p4m-button {
            padding: 10px;
            background-color: #808080;
            color: #000000;
            border-radius: 4px;
        }
        .p4m-button.p4m-button-active {
            background-color: #449044;
            color: #FFFFFF;
            border: none;
            margin: 4px;
        }
        .p4m-panel#summaryPanel {
            border-left: solid 1px #E0E0E0;
        }
        :root {
            --paper-tabs-selection-bar-color: red;
        }

    </style>

    <script>
    //
        Polymer({
            is: "p4m-checkout",

            properties: {
                sessionId: {
                    type: String
                },
                consumerData: {
                    type: Object,
                    notify: true
                },              
                cartData: {
                    type: Object,
                    notify: true
                   
                },
                deliveryData: {
                    type: Object,
                    notify: true
                },
                selectedTab: {
                    type: Number,
                    value: 0
                },
                _changeTimer: {
                    //Timer object to allow sending of changes once user has finished interaction
                    type: Object
                }
                
            },
            observers: ["onCartDataChange(cartData.Items.*)"],

            ready: function()
            {

                if (!this.sessionId) {
                    this.sessionId = this.$.sessionCookie.readCookie();
                }
                if (this.sessionId) {
                    this.getLocalCart();
                }
            },

            debug: function(e) {
                console.log("p4m-checkout debug", this.cartData);
            },

            getLocalCart: function () {
                this.$.localApi.call('getP4MCart',null, null, this.onCartData.bind(this) );
            },

            getP4mCart: function () {
                this.$.api.call('currentCart', { sessionId: this.sessionId }, null, this.onCartData.bind(this));
            },


            sendCartChanges: function () {

                console.log("Sending changes");
                var self = this;
                //Send changes to local API, then to P4m
                var changes = [];

                for (var sku in this.$.cart.changes) {
                    changes.push({ItemCode: sku, Qty: this.$.cart.changes[sku]});
                }
                if (changes.length > 0) {
                    this.$.localApi.call('itemQtyChanged', {}, changes, function () {
                        console.log("Called local api itemQtyChanged");
                        self.$.cart.clearChanges();
                        self.updateP4mCart();


                    });
                }
                else {
                    console.log("No changes to send");
                }


            },

            updateConsumer: function() {

            },

            updateP4mCart: function () {
                
                this.$.orderSummary.showAsLoading();

                //Send changes to P4M
                var cartMessage =
                {
                    "SessionId": this.sessionId,
                    "PaymentType": "DB",
                    "Currency": this.cartData.Currency,
                    "PayMethodToken": "this.consumerData.PayMethodToken",   // TODO: load the consumer
                    "ClearItems": true, // are we always replacing the whole cart? or ClearItems = this.cartData.Id === null; ??
                    "Cart": this.cartData
                };
                this.$.api.call('postCart', null, cartMessage, this.onCartData.bind(this));
            },

            onCartData: function (data) {
                console.log("Received new cart data");
                this.$.orderSummary.showAsLoaded();
                if (data.Success) {
                    this.cartData = data.Cart;
                    if (this.cartData.Id === null) {
                        console.log("Updating P4M");
                        //In this case we have retrieved the cart from the local server so we need to update P4M
                        this.updateP4mCart();
                    }
                }
                else {
                    console.error(data.Error);
                }                
            },

            onCartDataChange: function (e) {
                console.log('p4m-checkout: onCartDataChange()', JSON.stringify(e));
                //If this is a valid change record,
                if (e.path) {
                    //Start timer, then send changes.
                    //If more changes are detected while the timer is active, reset the timer.
                    if (this._changeTimer) window.clearTimeout(this._changeTimer);
                    this._changeTimer = window.setTimeout(this.sendCartChanges.bind(this), 2000);
                }
            }

        });
    </script>
</dom-module>
