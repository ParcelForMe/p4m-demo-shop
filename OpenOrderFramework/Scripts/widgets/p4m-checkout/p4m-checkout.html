<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/polymer-cookie/polymer-cookie.html" />
<link rel="import" href="../../Lib/paper-tabs/paper-tabs.html" />
<link rel="import" href="../../Lib/iron-pages/iron-pages.html" />

<link rel="import" href="../p4m-profile/p4m-profile.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../p4m-cart/p4m-cart.html" />
<link rel="import" href="../p4m-order-summary/p4m-order-summary.html" />
<link rel="import" href="../p4m-address-list/p4m-address-list.html" />
<link rel="import" href="../p4m-purchase/p4m-purchase.html" />
<link rel="import" href="../p4m-card-list/p4m-card-list.html" />
<link rel="import" href="../p4m-delivery/p4m-delivery.html" />
<link rel="import" href="../p4m-order-text/p4m-order-text.html" />
<link rel="import" href="../p4m-discount-input/p4m-discount-input.html" />
<link rel="import" href="../p4m-discount-list/p4m-discount-list.html" />

<link rel="import" href="../../Lib/gfs-checkout-widget/gfs-checkout-widget.html">

<link rel="stylesheet" href="../p4m-shared/p4m.css" />

<dom-module id="p4m-checkout">

    <template>
        <p4m-api id="api" ssl="true" host-base-domain="parcelfor.me" host-type="local" version="v2"></p4m-api>
        <p4m-api id="localApi" is-local="true"></p4m-api>
        <div id="container">
            <div id="topPanel" class="topPanel"><h2>Review My Order</h2><p4m-profile mode="basic"></p4m-profile></div>
            <div id="panelContainer">
                <div id="detailPanel" class="p4m-panel">
                    <paper-tabs selected="{{selectedTab}}">
                        <paper-tab>My Order</paper-tab>
                        <paper-tab>Delivery Options</paper-tab>
                        <paper-tab>Payment Options</paper-tab>
                        <paper-tab>Addresses</paper-tab>
                    </paper-tabs>
                    <iron-pages selected="{{selectedTab}}" on-iron-select="onSelectTab">                   
                        <iron-page name="cartPage">                       
                            <p4m-cart id="cart" cart-data="{{cartData}}"></p4m-cart>                         
                        </iron-page>
                        <iron-page name="deliveryPage">

                            <gfs-checkout id="gfsCheckoutWidget" gfs-data="{{gfsData}}" access-token="{{gfsAccessToken}}" on-show-droppoints="onGfsShowDroppoints" on-show-standard="onGfsShowStandard" on-selectedservicechanged="onGfsServiceChanged" delivery-preferences="{{deliveryPreferences}}" preferred-droppoints="{{preferredDroppoints}}"></gfs-checkout>

                            <template is="dom-if" if="{{_notUseGfsCheckout}}">
                                <p4m-delivery></p4m-delivery>
                            </template>
                            <template is="dom-if" if="{{useGfsCheckout}}">
                            </template>
                        </iron-page>
                        <iron-page name="cardPage">
                            <p4m-card-list consumer-data="{{consumerData}}" cart-data="{{cartData}}" on-selected="onSelectPaymentMethod" on-gotnewcard="onGotNewCard"></p4m-card-list>
                        </iron-page>
                        <iron-page name="addressPage">
                            <p4m-address-list id="addressList" address-list-data="{{consumerData.Addresses}}" cart-data="{{cartData}}" on-select="onSelectAddress" on-add="onAddAddress" on-update="onUpdateAddress"></p4m-address-list>
                        </iron-page>
                    </iron-pages>                 
                </div>
                <div id="summaryPanel" class="p4m-panel">
                    <p4m-order-text cart-data="{{cartData}}" consumer-data="{{consumerData}}"></p4m-order-text>
                    <hr />
                    <p4m-purchase id="p4mPurchase" cart-data="{{cartData}}" selected-card="{{selectedCard}}" use-paypal="true"></p4m-purchase>
                    <p4m-order-summary id="orderSummary" cart-data="{{cartData}}"></p4m-order-summary>  
                    <p4m-discount-input on-discount="onDiscount"></p4m-discount-input>  
                    <hr />    
                    <p4m-discount-list cart-data="{{cartData}}" on-discountdelete="onDiscountDelete"></p4m-discount-list>         
                    <hr />        
                </div>

            </div>
            
        </div>

        <polymer-cookie id="sessionCookie" name="CartId"></polymer-cookie>
    </template>

    <style>
        #container {
            width: 100%;
            margin: auto;
        }
        #panelContainer {
            display: flex;
            border-radius: 5px;
            background-color: white;

        }
        .topPanel {
            width: 100%;
            background-color: #E0E0E0;
            border: none;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            padding: 20px;
        }
        .topPanel h2 {
            margin: 0px;
            letter-spacing: 3px;
            text-transform: uppercase;
            display: inline-block;
        }

        .topPanel p4m-profile {
            float: right;
            margin-top: -8px;
        }   
        .panelContainer {
            border-bottom-right-radius: 8px;
            border-bottom-left-radius: 8px;
            display: flex;
            flex-direction: row;
        }

        .p4m-panel {
            width: 50%; 
            min-height: 200px;
            border: none;
        }

        .p4m-panel#summaryPanel {
            border-left: solid 1px #E0E0E0;
        }
        :root {
            --paper-tabs-selection-bar-color: red;
        }
        #panelContainer > div {
            transition: all 0.25s ease-in-out;
        }
        .smallSummary #detailPanel.p4m-panel {
            width: 75%;
        }
        .smallSummary #summaryPanel.p4m-panel {
            width: 25%;
        }

        

    </style>

    <script>
        //
        /*window.addEventListener('selectedServiceChanged', function (e) {
            console.log('p4m: selectedServiceChanged', e);
        });*/

        Polymer({
            is: "p4m-checkout",

            properties: {
                sessionId: {
                    type: String
                },
                consumerData: {
                    type: Object,
                    notify: true,
                    observer: "onConsumerDataChange"
                },              
                cartData: {
                    type: Object,
                    notify: true,
                },
                deliveryData: {
                    type: Object,
                    notify: true
                },
                selectedTab: {
                    type: Number,
                    value: 0
                },
                currency: {
                    type: String,
                    value: "GBP"
                },
                selectedCard: {
                    type: Object
                },
                useGfsCheckout: {
                    type: Object,
                    value: false
                },
                gfsAccessToken: {
                    type: String
                },
                gfsData: {
                    type: String
                },
                _notUseGfsCheckout: {
                    type: Object,
                    value: true
                },
                _changeTimer: {
                    //Timer object to allow sending of changes once user has finished interaction
                    type: Object
                }
                
            },
            observers: [
                //"onCartDiscountChange(cartData.Discounts.*)"
               "onCartItemsChange(cartData.Items.*)"
            ],

            ready: function()
            {
                this._notUseGfsCheckout = !this.useGfsCheckout;

                if (!this.sessionId) {
                    this.sessionId = this.$.sessionCookie.readCookie();
                }
                if (this.sessionId) {
                    this.getLocalCart();
                }

                this.$.api.call('consumer', null, null, this.onConsumerData.bind(this));
            },

            debug: function(e) {
                console.log("p4m-checkout debug", this.cartData);
            },

            getLocalCart: function () {
                this.$.localApi.call('getP4MCart',null, null, this.onCartData.bind(this) );
            },

            getP4mCart: function () {
                this.$.api.call('currentCart', { sessionId: this.sessionId }, null, this.onRemoteCartData.bind(this));
            },

            sendCartItemChanges: function () {          
                //Send changes to local API, then to P4m
                var self = this;
                var changes = [];

                for (var sku in this.$.cart.changes) {
                    changes.push({ItemCode: sku, Qty: this.$.cart.changes[sku]});
                }
                if (changes.length > 0) {
                    this.$.localApi.call('itemQtyChanged', {}, changes, function (newCartTotals) {
                        //console.log("Called local api itemQtyChanged");
                        self.$.cart.clearChanges();
                        self.updCartTotals(newCartTotals);
                        self.cartData.Discounts = newCartTotals.Discounts;
                        self.updateP4mCart();
                    });
                }
                else {
                    //console.log("No changes to send");
                }


            },

            updCartTotals: function(newCartTotals) {
                this.cartData.Tax = newCartTotals.Tax;
                this.cartData.ShippingAmt = newCartTotals.Shipping;
                this.cartData.Total = newCartTotals.Total;
            },

            onConsumerData: function(data) {
                this.consumerData = data.Consumer;
                var p4mCollectPoints = this.consumerData.Addresses
                    //TODO: Find out why DropPointProviderId is always 0
                    .filter(function (item) { return (item.AddressType == "Collect" && item.Latitude && /*item.DropPointProviderId &&*/ item.DropPointId) })
                    .map(function (item) {
                        var gfsAddress = {
                            droppointId: item.DropPointId,
                            droppointDescription: item.CompanyName,
                            geoLocation: {
                                    
                                postCode: item.PostCode,
                                addressLines: [item.CompanyName, item.Street1],
                                town: item.City,
                                coordinates: {
                                    latitude: item.Latitude,
                                    longitude: item.Longitude                                
                                },
                                countryCode: item.CountryCode,
                                county: "",
                                directions: ""
                            },
                            providerId: item.DropPointProviderId,
                            providerLogo: "https://s-media-cache-ak0.pinimg.com/avatars/pelithepenguin_1453991623_140.jpg",
                            providerName: item.Label                        
                        };
                        return gfsAddress;
                    });
                this.$.gfsCheckoutWidget.setPreferredDroppoints(p4mCollectPoints);
            },

            onConsumerDataChange: function(newVal, oldVal) {
            },

            updateP4mCart: function () {
                this.$.orderSummary.showAsLoading();
                this.$.p4mPurchase.setLoadingState(true);

                //Send changes to P4M
                var cartMessage =
                {
                    "SessionId": this.sessionId,
                    "ClearItems": true, // are we always replacing the whole cart? or ClearItems = this.cartData.Id === null; ??
                    "Cart": this.cartData
                };
                this.$.api.call('postCart', null, cartMessage, this.onRemoteCartData.bind(this));
            },

            onRemoteCartData: function(data) {
                if (!data.Success) {
                    console.error(data.Error);
                    this.onCartData(data);
                } 
                   
                else if (!data.Cart || !data.Cart.Items || data.Cart.Items.length === 0) {
                    window.location.reload(true);
                }                  
                else {
                    this.onCartData(data);
                }
                    
            },

            onCartData: function (data) {
                this.$.orderSummary.showAsLoaded();
                this.$.p4mPurchase.setLoadingState(false);
                this.$.p4mPurchase.updateUi();
                if (data.Success) {
                    this.cartData = data.Cart;
                    if (this.cartData && this.cartData.Id === null) {
                        //console.log("Updating P4M");
                        //In this case we have retrieved the cart from the local server so we need to update P4M
                        this.updateP4mCart();
                    }
                }
                else {
                    console.error(data.Error);
                }                
            },

            onCartItemsChange: function (e) {
                //console.log('p4m-checkout: onCartItemsChange()', JSON.stringify(e));
                //If this is a valid change record,
                if (e.path) {
                    //Start timer, then send changes.
                    //If more changes are detected while the timer is active, reset the timer.
                    if (this._changeTimer) window.clearTimeout(this._changeTimer);
                    this._changeTimer = window.setTimeout(this.sendCartItemChanges.bind(this), 2000);
                }
            },

            // the following methods relate to changes at the cart level (not the items):

            updateShipping: function (data) { //service, shipping, expDeliveryDate, collectPoint) {
                var self = this;

                this.cartData.ShippingAmt = data.shipping;
                this.cartData.ServiceName = data.service;
                this.cartData.ExpDeliveryDate = data.expDeliveryDateEnd;

                var shippingDetails = { 'Service': data.service, 'Amount': data.shipping, 'DueDate': data.expDeliveryDateEnd };
                // got new shipping details so we need to get updated tax from the host
                this.$.localApi.call('shippingDetails', null, shippingDetails, function (cartTotals) {
                    self.updCartTotals(cartTotals); // this updates tax
                    self.cartData.Carrier = data.carrier;
                    self.cartData.ShippingAmt = data.shipping;
                    self.cartData.ServiceName = data.service;
                    self.cartData.ExpDeliveryDate = data.expDeliveryDateEnd;
                    if (data.collectionPoint) {
                        self.selectCollectPoint(data.carrier, data.collectionPoint, data.deliveryAddress, function () {
                            self.updateP4mCart();
                        });
                    }
                    else {
                        self.updateP4mCart();
                    }
                });
            },


            selectCollectPoint: function (carrier, collectPointId, collectPointAddress, callback) {
                //Make API call to add invisible address
                var self = this;
                var existingDropPoint = this.$.addressList.getDropPointById(collectPointId);
                if (!existingDropPoint) {
                    var directions = collectPointAddress.directions ? collectPointAddress.directions.split("]").pop() : "";
                    var prefOrder = this.consumerData.Addresses.length || 1;
                    var postData =
                    {
                        "Address": {
                            "AddressType": "Collect",
                            "Label": carrier,
                            "CompanyName": directions,
                            "Street1": collectPointAddress.addressLines[0] || "",
                            "Street2": collectPointAddress.addressLines[1] || "",
                            "City": collectPointAddress.town,
                            "PostCode": collectPointAddress.postCode,
                            "State": collectPointAddress.county,
                            "Country": collectPointAddress.country,
                            "CountryCode": collectPointAddress.countryCode,
                            "Phone": collectPointAddress.phone,
                            "Latitude": collectPointAddress.coordinates.latitude,
                            "Longitude": collectPointAddress.coordinates.longitude,
                            "DropPointProviderId": collectPointAddress.DropPointProviderId,
                            "DropPointId": collectPointId,
                            "CollectPrefOrder": prefOrder
                        },
                        "isPrefDeliveryAddr": false,
                        "isBillingAddr": false
                    };

                   
                    this.$.api.call("postAddress", null, postData, function (result) {
                        self.cartData.AddressId = result.Address.Id;
                        self.consumerData.Addresses.push(result.Address);
                        //self.cartData.ServiceName = "Collection point";
                        callback(result);
                    });
                }
                else {
                    self.cartData.AddressId = collectPointAddress.Id;
                    callback(existingDropPoint);
                }
            },

            toggleDetailExpansion: function(expand) {             
                if (expand) {
                    this.$.panelContainer.classList.add('smallSummary');
                }
                else {
                    this.$.panelContainer.classList.remove('smallSummary');
                }
            },

            onSelectPaymentMethod: function (e) {
                var updCart = this.selectedCard !== undefined && this.selectedCard !== null;
                this.set('cartData.PayMethodId', e.detail.Id);
                this.selectedCard = e.detail;
                if (updCart) {
                    this.updateP4mCart();
                }
            },

            onCardHashData: function (data) {
                this.set('cardTimestamp', data.Timestamp);
                this.set('cardMerchantId', data.MerchantId);
                this.set('cardHash', data.Hash);               
            },

            onDiscount: function (e) {
                this.set('cartData.Tax', Number(e.detail.Tax));
                var cartDiscount = this.cartData.Discounts.find((element, index, arr) => element.Code === e.detail.Code);
                if (cartDiscount) {
                    console.log("Added existing discount")
                    if (cartDiscount.Description !== e.detail.Description ||
                        cartDiscount.Amount !== e.detail.Amount ||
                        cartDiscount.Code !== e.detail.Code)
                    {
                        cartDiscount.Description = e.detail.Description;
                        cartDiscount.Amount = e.detail.Amount;
                        cartDiscount.Code = e.detail.Code;
                        this.cartData.Tax = e.detail.Tax;
                        this.updateP4mCart();
                    }
                }
                else {
                    this.push('cartData.Discounts',
                    {
                        Description: e.detail.Description,
                        Amount: e.detail.Amount,
                        Code: e.detail.Code
                    });
                    this.cartData.Tax = e.detail.Tax;
                    this.updateP4mCart();
                }
            },

            onDiscountDelete: function (e, code) {

                var item = this.cartData.Discounts.find((element, index, arr) => element.Code === code);
                if (item) {
                    item.Amount = 0;
                    item.Description = "Deleted";
                    this.cartData.Tax = e.detail.Tax;
                    this.updateP4mCart();
                    this.$.localApi.call('removeDiscountCode', {"discountCode": code}, null, null);
                }
            },

            onGotNewCard: function(){
                this.$.api.call('consumer', null, null, this.onConsumerData.bind(this));
            },

            onSelectAddress: function (e) {
                if (e.detail) {
                    if (e.detail.isBilling) {
                        this.set('cartData.BillingAddressId', e.detail.id);
                    }                       
                    else if (e.detail.isDelivery) {
                        this.set('cartData.AddressId', e.detail.id);
                    }                    
                    this.updateP4mCart();
                }
            },

            onAddAddress: function (addressElement) {
                this.onUpdateAddress(addressElement);
            },

            onUpdateAddress: function (addressElement) {
                // here we're adding or updating an address only, not setting a default value on the consumer at this stage
                //zzzzzzzz
                this.$.addressList.showAsLoading();
                var postData =
                {
                    "Address": addressElement.detail.addressData
                };
                var self = this;
                this.$.api.call("postAddress", null, postData, function (result) {
                    console.log("Got address result: ", result);
                    addressElement.detail.addressData.Id = result.Address.Id;
                    //addressElement.detail.mode = "view";
                    self.$.addressList.showAsLoaded();
                });
            },

            onSelectTab: function(e) {

            },

            onGfsServiceChanged: function (e) {
                console.log("p4m widget: onGfsServiceChanged():", e);
                this.updateShipping(e.detail);
            },

            onGfsShowDroppoints: function (e) {
                this.toggleDetailExpansion(true);
            },

            onGfsShowStandard: function (e) {
                this.toggleDetailExpansion(false);
            }


        });
    </script>
</dom-module>
