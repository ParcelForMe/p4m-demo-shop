<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../../Lib/paper-spinner/paper-spinner.html" />


<dom-module id="p4m-profile">

    <template>
        <div id="p4m-profile-container" class$="{{_topClass}}">
            <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
            <polymer-cookie id="p4mAvatarCookie" name="p4mAvatarUrl"></polymer-cookie>
            <p4m-api id="api" ></p4m-api>
            <div id="profileName">{{p4mData.Consumer.GivenName}}</div>
            <img id="profileImage" src$="{{_profilePicUrl}}" />  
            <paper-spinner id="spinner"></paper-spinner>         
        </div>
    </template>

    <style>

        #p4m-profile-container {
            display: flex;
            flex-direction: row;
        }
        #profileImage {
            height: 50px;
            border-radius: 50px;
            -webkit-border-radius: 25px;
            -moz-border-radius: 25px;
        }
        #profileName {
            font-size: 18px;
            margin-top: 12px;
            margin-right: 6px;
        }
        #profileImage.hide-image {
            display: none;
        }
        #profileName.hide-name {
            display: none;
        }

        #spinner {
            width: 50px;
            height: 50px;
        }
        .hidden {
            display: none;
        }
    </style>

    <script>
    //
        Polymer({
            is: "p4m-profile",

            properties: {   
                p4mData: {
                    type: Object,
                    notify: true
                },
                mode: {
                    type: String
                },
                hideImage: {
                    type: Object,
                    value: false
                },
                hideName: {
                    type: Object,
                    value: false
                },
                autoLoad: {
                    type: Object,
                    value: false
                },
                _loggedIn: {
                    type: Object,
                    value: false
                },
                _topClass: {
                    type: String,
                    value: ""
                },
                _profilePicUrl: {
                    type: String
                }
            },

            ready: function()
            {
                this.showAvatar();
                if (this.mode == "basic") {
                    this.hideImage = false;
                    this.hideName = true;
                }
                if (this.hideImage) this.topClass += " hide-image";
                if (this.hideName) this.topClass += " hide-name";

                window.addEventListener('p4m_getConsumerDetails', this.onProfile.bind(this));
                if (this.autoLoad) {
                    this.showSpinner();
                    this.$.api.call('getConsumerDetails');
                }
            },

            showAvatar: function () {
                this.hideSpinner();
                var token = this.$.p4mTokenCookie.readCookie();
                this._loggedIn = token != "";
                this._profilePicUrl = this.$.p4mAvatarCookie.readCookie();
                if (!this._profilePicUrl) {
                    if (this._loggedIn)
                        this._profilePicUrl = "/Scripts/widgets/p4m-profile/peli-logo-green.png";
                    else
                        this._profilePicUrl = "/Scripts/widgets/p4m-profile/peli-logo-grey.png";
                }
            },

            onProfile: function (e) {
                this.p4mData = e.detail;
                this.showAvatar();
            },

            hideSpinner: function () {
                this.$.spinner.active = false;
                this.$.spinner.classList.add('hidden');
            },

            showSpinner: function () {
                this.$.spinner.active = true;
                this.$.spinner.classList.remove('hidden');
            }
        });
    </script>
</dom-module>