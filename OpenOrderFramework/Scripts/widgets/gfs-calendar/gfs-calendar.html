
<link rel="import" href="../../Lib/polymer/polymer.html" />

<dom-module id="gfs-calendar">

    <template>
        <div id="calendar-body">
            <div class="calendar-col calendar-delivery-label">
                <div class="calendar-cell calendar-day-label">Time</div>               
                <template is="dom-repeat" items="{{_deliveryLabels}}">
                    <div class="calendar-cell calendar-delivery-label"><div>Before</div><div>{{item}}</div></div>
                </template>
            </div>
            <template id="calendarTemplate" is="dom-repeat" items="{{_calendar}}" as="calendarItem" filter="_filterBySelectedWeek">
                <div class="calendar-col calendar-day">
                    <div class="calendar-cell calendar-day-label"><div>{{calendarItem.deliveryDowLabel}}</div><div>{{calendarItem.deliveryDateLabel}}</div></div>
                    <template is="dom-repeat" items="{{calendarItem.slots}}" as="shippingOption">
                        <template restamp="true" is="dom-if" if="{{!_calendarShippingOptionIsSelected(shippingOption)}}">                           
                            <div class="calendar-cell calendar-delivery-option" shipping-option-id$="{{shippingOption.id}}" delivery-date$="{{calendarItem.data.deliveryDate}}" day-index$="{{shippingOption.dayIndex}}" on-click="selectShippingOptionCell"><div>{{shippingOption.localizedPrice}}</div></div>
                        </template>
                        <template restamp="true" is="dom-if" if="{{_calendarShippingOptionIsSelected(shippingOption)}}">
                            <div class="makeFollowingSelected"></div>
                            <div class="calendar-cell calendar-delivery-option" shipping-option-id$="{{shippingOption.id}}" delivery-date$="{{calendarItem.data.deliveryDate}}" day-index$="{{shippingOption.dayIndex}}" on-click="selectShippingOptionCell"><div>{{shippingOption.localizedPrice}}</div></div>
                        </template>
                    </template>                
                </div>
            </template>

        </div>
        <div class="calendar-buttons">
            <div on-click="seePreviousWeek" class$="gfs-button {{_previousWeekClass}}">See previous 7 days</div>
            <div on-click="seeNextWeek" class$="gfs-button {{_nextWeekClass}}">See next 7 days</div>
        </div>

    </template>

    <style>
        #calendar-body {
            display: flex;
            flex-direction: row;
            justify-content: center;
            border-top: 1px solid silver;
            border-right: 1px solid silver;
            border-left: 1px solid silver;
        }

        .calendar-col {
            display: flex;
            flex-direction: column;   
            margin: auto;
            width: 100%;                  
        }
        
        .calendar-day-label {
        }

        .calendar-cell {
            height: 64px;
            width: auto;
            border-bottom: solid silver 1px;
            display: flex;
            flex-direction: column;
            text-align: center;
            justify-content: center;
            padding: 4px;

        }
        .calendar-delivery-option.calendar-cell:hover {
            background-color: silver;
        }


        .calendar-delivery-option {
            font-weight: bold;
        }

        .calendar-buttons {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        .calendar-buttons div.gfs-button {
            min-width: 180px;
        }

        .concealed {
            visibility:hidden;
        }

        .makeFollowingSelected + div {
            background-color: #f8cb37;           
        }

    </style>

    <script>

        Polymer({
            is: "gfs-calendar",
            properties: {
                dayDefiniteData: {
                    type: Array,
                    value: [],
                    notify: true
                },
                maxWeeks: {
                    type: Number,
                    value: 2
                },
                selectedShippingMethodId: {
                    type: String,
                    notify: true,
                    observer: "_updateSelectedShippingMethodId"
                },
                selectedDeliveryDate: {
                    type: String,
                    notify: true,
                    observer: "_updateSelectedDeliveryDate"
                },
                selectedWeek: {
                    type: Number,
                    value: 1,
                    notify: true
                },
                _buckets: {
                    type: Array,
                    value: []
                },
                _calendar: {
                    type: Array,
                    value: []
                },
                _deliveryLabels: {
                    type: Array,
                    value: []
                },
                _nextWeekClass: {
                    type: String
                },
                _previousWeekClass: {
                    type: String
                }
            },
            observers: [
                 "onDataChange(dayDefiniteData.*)",
                 "onWeekChange(selectedWeek)"
            ],
            listeners: {

            },
            ready: function()
            {
            },

            seeNextWeek: function () {
                if (this.selectedWeek < this.maxWeeks) {
                    this.set('selectedWeek', this.selectedWeek + 1);
                }
            },

            seePreviousWeek: function() {
                if (this.selectedWeek > 1) {
                    this.set('selectedWeek', this.selectedWeek - 1);
                }
            },

            _updateUi: function () {
                var self = this;
                if (this.selectedWeek <= 1) {
                    this.set('_previousWeekClass', 'concealed');
                }
                else {
                    this.set('_previousWeekClass', 'enabled');
                }
                if (this.selectedWeek >= this.maxWeeks) {
                    this.set('_nextWeekClass', 'concealed');
                }
                else {
                    this.set('_nextWeekClass', 'enabled');
                }

                //Trigger a full refresh               
                if (this._calendar) {
                    var _calendar = JSON.parse(JSON.stringify(this._calendar));
                    this.set('_calendar', _calendar);
                }

            },

            _updateSelectedShippingMethodId: function () {
                this._updateUi();
            },

            _updateSelectedDeliveryDate: function() {
                this._updateUi();
            },

            _prepare: function() {
                //Scan several days ahead, finding the day with the most delivery times. This will be the template.

                var self = this;
                var maxDeliveryTimes = 0;
                var bucketTemplate;
                var i = 0;

                if (!this.dayDefiniteData.length) return;
                this.dayDefiniteData.forEach(function (dayData) {
                    dayData._rates = dayData.rates.filter(function (item) { return item.serviceType.type !== "dmStandardDropPoint" });

                    // dayData.endTimes = [];
                    if (dayData._rates.length > maxDeliveryTimes) {
                        maxDeliveryTimes = dayData._rates.length;
                        bucketTemplate = dayData._rates;
                    }

                });

                //Make buckets  
                this._buckets = [];

                bucketTemplate.forEach(function (rateData) {
                    self._buckets.push(dateToTimeMinutes(new Date(rateData.deliveryTimeTo)));
                })
                this._buckets = this._buckets.sort(function (a, b) { return a > b ? 1 : -1 });

                //Fill buckets
                this._calendar = [];
                this.dayDefiniteData.forEach(function (dayData) {
                    var today = {
                        dayIndex: i,
                        data: dayData,
                        deliveryDowLabel: getDowLabel(new Date(dayData.deliveryDate)),
                        deliveryDateLabel: getDateLabel(new Date(dayData.deliveryDate)),
                        slots: Array.apply(null, Array(self._buckets.length))//.map(function (item) { return {price: "---"}}); //empty array of rate slots
                    };
                    i++;
                    dayData._rates.forEach(function (rateData) {
                        rateData.deliveryDate = dayData.deliveryDate;
                        rateData.dayIndex = today.dayIndex;
                        var minutes = dateToTimeMinutes(new Date(rateData.deliveryTimeTo));
                        var bucketIndex = self._getBucket(minutes);
                        if (bucketIndex == -1) {
                            //stretch out the top bucket to accomodate this one
                            self._buckets[self._buckets.length - 1] = minutes;
                        }
                        else {
                            today.slots[bucketIndex] = rateData;
                        }
                    });
                    today.slots = today.slots.map(function (item) {
                        if (!item) item = { localizedPrice: "" }
                        else if (!item.price) item.localizedPrice = "Free";
                        return item;
                    });
                    self.push("_calendar", today);

                });


                //Make labels
                this._deliveryLabels = [];                
                this._buckets.forEach(function (bucketTime) {
                    self.push("_deliveryLabels", minutesToTimeStr(bucketTime));
                });

                if (this._autoSelect) {
                    this.autoSelect();
                }

            },

            _getBucket: function (boundary) {
                var foundBucket;
                for (var i=0; i < this._buckets.length; i++) {
                    if (boundary <= this._buckets[i]) {
                        foundBucket = i;
                        break;
                    }
                }
                if (typeof(foundBucket) === "undefined") {
                    return -1;
                }
                else {
                    return foundBucket;
                }
            },

            _filterBySelectedWeek: function (item) {
                var from = (this.selectedWeek-1) * 7;
                var to = this.selectedWeek * 7;
                return (item.dayIndex >= from && item.dayIndex < to);
            },

            onDataChange: function () {
                this._prepare();
            },

            onWeekChange: function () {
                this._updateUi();
                               
            },

            autoSelect: function () {
                var nextDeliverySlot;
                this._autoSelect = true; //If true, autoselection will trigger after initialisation. Ie, run this again later if the data isn't present yet.

                //If the calendar has already loaded, select the option immediately
                if (this._calendar && this._calendar[0]) {
                    for (var d=0; d<this._calendar.length || !nextDeliverySlot; d++) {
                        var day = this._calendar[d];
                        if (day.slots && day.slots.length) {
                            for (var s = 0; s < day.slots.length && !nextDeliverySlot; s++) {
                                if (day.slots[s].id) {
                                    nextDeliverySlot = day.slots[s];
                                    break;
                                }
                            }
                        }
                        if (nextDeliverySlot) break;
                    }
                    if (nextDeliverySlot) {
                        this.selectShippingOption(nextDeliverySlot.id, nextDeliverySlot.deliveryDate);
                    }
                    else {
                        console.error("No calendar delivery slots available");
                    }
                        

                   
                }
                
            },

            selectShippingOption: function (methodId, deliveryDateStr) {
                //var shippingOption = e.currentTarget.getAttribute('data-shipping');
                //shippingOption.selected = true;
                this.selectedShippingMethodId = methodId;
                this.selectedDeliveryDate = deliveryDateStr;
                this.fire('select-shipping-option',
                    {
                        shippingMethodId: this.selectedShippingMethodId,
                        deliveryDate: this.selectedDeliveryDate
                    }
                );
                this._updateUi();
            },

            selectShippingOptionCell: function (e) {
               this.selectShippingOption(e.currentTarget.getAttribute('shipping-option-id'), e.currentTarget.getAttribute('delivery-date'));
            },

            _calendarShippingOptionIsSelected: function (item) {
                var selectedDeliveryDate;
                if (this.selectedDeliveryDate) {
                    selectedDeliveryDate = new Date(Math.floor((new Date(this.selectedDeliveryDate).getTime()) / DAY_MS) * DAY_MS);//Remove time component
                    if ((this.selectedShippingMethodId == item.id) && (selectedDeliveryDate.getTime() == new Date(item.deliveryDate).getTime())) {
                        return true;
                    }
                    else return false;
                }
                else return false;              
           }
        });

        function dateToTimeMinutes(date) {
            return (date.getUTCHours() * 60) + date.getUTCMinutes();
        }

        function minutesToTimeStr(minutes) {
            var d = new Date(minutes * 60 * 1000);
            return d.getUTCHours() + ":" + zeroPad(d.getUTCMinutes(), 2); //.toLocaleTimeString();
        }

        function zeroPad(num, places) {
            var zero = places - num.toString().length + 1;
            return Array(+(zero > 0 && zero)).join("0") + num;
        }

        function getDowLabel(date) {
            var dow = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            return dow[date.getDay()] + ""
        }

        function getDateLabel(date) {
            var suffixes = ["st", "nd", "rd", "th"];
            var dom = date.getDate();
            var suffix = suffixes[Math.min(suffixes.length-1, dom)];
            return dom.toString() + suffix;
        }



    </script>
</dom-module>