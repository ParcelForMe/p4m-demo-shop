<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/iron-ajax/iron-ajax.html" />
<link rel="import" href="../../Lib/polymer-cookie/polymer-cookie.html" />

<dom-module id="p4m-login">

    <template>
        <p4m-profile on-click="launchPopup"></p4m-profile>
        <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
        <polymer-cookie id="p4mStateCookie" name="p4mState" value={{_state}}></polymer-cookie>
        <polymer-cookie id="p4mNonceCookie" name="p4mNonce" value="{{_nonce}}"></polymer-cookie>  
    </template>

    <script>
        Polymer({
            is: "p4m-login",

            properties: {
                authBaseUrl: {
                    type: String,
                    value: "https://local.parcelfor.me:44333/core/connect/authorize"
                },
                clientId: {
                    type: String,
                    value: "p4m-login-test"
                },
                redirectUrl: {
                    type: String,
                    value: "http://localhost:3000/getP4MAccessToken"
                },
                logoutForm: {
                    type: String,
                    value: "logoutForm"
                },
                logoutUrl: {
                    type: String,
                    value: "https://local.parcelfor.me:44333/core/connect/endsession"
                },
                p4mToken: {
                    type: String
                },

                _state: {
                    type: String
                },
                _nonce: {
                    type: String
                },
                _authCompletionInterval: {
                    type: Object
                }
            },
            listeners: {

            },

            ready: function () {
                this._getTokenCookie();
            },

            launchPopup: function()
            {
                if (!this.p4mToken || this.p4mToken === '') {
                    //Make AuthUrl
                    this._makeState();
                    this._makeAuthUrl();
                    window.open(this._authUrl);
                    this._waitForAuthCompletion();
                }
                else {
                    window.open(this.logoutUrl);
                    if (this.logoutForm && this.logoutForm != '') {
                        document.getElementById(this.logoutForm).submit();
//                        window.location.reload(true);
                    }
                }
            },

            _makeState: function() {
                this._state = Math.floor(Math.random() * 999999).toString();
                this._nonce = Math.floor(Math.random() * 999999).toString() + '-' + Math.floor(Math.random() * 999999).toString();
                this.$.p4mStateCookie.createCookie();
                this.$.p4mNonceCookie.createCookie();
            },

            _makeAuthUrl: function() {
                this._authUrl = 
                    this.authBaseUrl
                    + "?response_type=code&client_id=" + this.clientId
                    + "&redirect_uri=" + this.redirectUrl 
                    + "&scope=openid%20p4mApi%20p4mRetail"
                    + "&state=" + this._state
                    + "&nonce=" + this._nonce
                    + "&display=popup";
            },

            _getTokenCookie: function() {
                this.p4mToken = this.$.p4mTokenCookie.readCookie();
                return this.p4mToken;
            },

            _waitForAuthCompletion: function() {
                this._authCompletionInterval = window.setInterval(this._checkAuthIsComplete.bind(this), 200);
            },

            _checkAuthIsComplete: function() {
                if (this._getTokenCookie()) {
                    if (this._authCompletionInterval) {
                        window.clearTimeout(this._authCompletionInterval);
                    }
                    this._onAuthCompletion();
                }

            },

            _onAuthCompletion: function () {
                window.location.reload(true);
            },

            _onConsumerDetails: function(data) {
                console.log(JSON.stringify(data));
            }
        });
    </script>
</dom-module>