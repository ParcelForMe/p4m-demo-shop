<link rel="import" href="../../Lib/polymer/polymer.html" />
<link rel="import" href="../../Lib/iron-collapse/iron-collapse.html" />
<link rel="import" href="../p4m-card/p4m-card.html" />
<link rel="import" href="../p4m-card/p4m-new-card.html" />

<dom-module id="p4m-card-list">

    <template>
        <div id="container">
            <p><a id="addNewCardLink" href="#" on-tap="addNewCard">Add a new card</a></p>
            <br />
            <iron-collapse id="newCardCollapse">
                <p4m-new-card id="newCard" consumer-data="{{consumerData}}"></p4m-new-card>
            </iron-collapse>
            
            <template is="dom-repeat" items="{{consumerData.PaymentMethods}}"><!-- filter="_cardsOnly">-->
                <p4m-card card-data="{{item}}" on-selected="onCardSelected" selected-card-id="{{selectedCardId}}"></p4m-card>
            </template>
        </div>

    </template>

    <style>
        #container {
            display: flex;
            flex-direction: column;
        }
    </style>

    <script>
    //
        Polymer({
            is: "p4m-card-list",

            properties: {
                consumerData: {
                    type: Object,
                    notify: true
                },
                cartData: {
                    type: Object,
                    notify: true
                },
                selectedCardId: {
                    type: String,
                    notify: true
                }
            },

            observers: [
                "onConsumerDataChange(consumerData.DefaultPayMethodId)",
                "onCartDataChange(cartData.PayMethodId)"
            ],

            ready: function()
            {
            },

            onCardSelected(e) {
                this.set("selectedCardId", e.detail.Id); //This should now trigger the other cards to update their UI
            },

            addNewCard: function () {
                var ctrl = this.$.newCardCollapse;
                var lbl = this.$.addNewCardLink;
                if (!ctrl.opened) {
                    this.$.newCard.loadRealexForm();
                    lbl.innerText = "Cancel";
                }
                else {
                    lbl.innerText = "Add a new card";
                }
                ctrl.toggle();
            },

            onConsumerDataChange: function () {
                if (false && !this.selectedCardId && this.consumerData) {
                    console.log("Setting selectedCardId to", this.consumerData.DefaultPayMethodId);
                    var foundDefaultCard = this.getCardDataById(this.consumerData.DefaultPayMethodId);
                    if (foundDefaultCard) {
                        this.set('selectedCardId', this.consumerData.DefaultPayMethodId);
                        this.fire('selected', foundDefaultCard);
                    }
                }
            },

            onCartDataChange: function () {
                if (!this.selectedCardId && this.cartData && this.cartData.PayMethodId) {
                    console.log("Setting selectedCardId to", this.cartData.PayMethodId);
                    var foundCard = this.getCardDataById(this.cartData.PayMethodId || this.consumerData.PayMethodId);
                    if (foundCard) {
                        this.set('selectedCardId', this.cartData.PayMethodId);
                        this.fire('selected', foundCard);
                    }
                }
            },

            getCardDataById: function (id) {
                var item;
                for (var i = 0; i < this.consumerData.PaymentMethods.length; i++) {
                    item = this.consumerData.PaymentMethods[i];
                    if (item.Id === id) {
                        return item;
                    }
                }
            },

            _cardsOnly: function (item) {
                return true;// (item && item.AccountType && item.AccountType === "Card");
            }


        });
    </script>
</dom-module>
