<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../../Lib/brick-calendar/dist/brick-calendar.html" />
<link rel="import" href="../../Lib/iron-ajax/iron-ajax.html" />
<link rel="import" href="../../Lib/iron-list/iron-list.html" />
<link rel="import" href="../../Lib/iron-collapse/iron-collapse.html" />
<link rel="import" href="../gfs-droppoint/gfs-droppoint.html" />
<link rel="import" href="../gfs-droppoint/gfs-droppoint-text.html" />
<link rel="import" href="../../Lib/gfs-delivery-address/gfs-delivery-address.html" />
<link rel="import" href="../../Lib/gfs-checkout-widget/map-region-manager/map-region-manager.html" />
<link rel="import" href="../../Lib/paper-toggle-button/paper-toggle-button.html" />
<link rel="import" href="../../Lib/paper-spinner/paper-spinner.html" />
<link rel="import" href="../../Lib/paper-toast/paper-toast.html" />
<link rel="import" href="../../Lib/paper-button/paper-button.html" />
<link rel="import" href="../../Lib/paper-tabs/paper-tabs.html" />
<link rel="import" href="../../Lib/iron-pages/iron-pages.html" />

<script src="../../Lib/momentjs/min/moment.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMQhcXM06TZBHZ95LwJBRVGSV4CqUQMpI&libraries=places"></script>
<link href="css/custom.css" rel="stylesheet" />

<dom-module id="gfs-checkout">
    <!--<link rel="import" type="css" href="custom.css">-->

    <template>
        <style>


            h3 {
                margin-left: 0px;
                clear: left;
                margin-top: 0px;
            }

            div, span, h3, ul {
                font-family: "Raleway", "Helvetica Neue", Verdana, Arial, sans-serif;
            }

            .toggle-title {
                width: 100%;
                cursor: pointer;
            }

            .toggle-content {
                margin-top: 10px;
                margin-bottom: 10px;
            }

            .hidden {
                display: none;
                z-index: 0;
            }

            input[type=radio] {
                margin-right: 4px;
            }

            ul {
                padding: 5px;
            }

            li {
                display: flex;
            }

            li label {
                margin-top: 5px;
                margin-left: 4px;
            }

            #mapContainer {
                display: block;
                position: relative;
            }

            #gfsMapCanvas {
                height: 400px;
                top: 0;
                left: 0;
            }

            #gfsSidebar {
                display: block;
                width: 350px;
                overflow-y: auto;
                padding: 10px;
            }

            #mainMapArea {
                width: 100%;
            }

            #mainMapArea.showPreferredDroppoints #gfsMapCanvas {
                width: 60%;
                float: left;
            }


            #mainMapArea.showPreferredDroppoints .preferredDroppoints {
                width: 37%;
                float: right;
                height: 400px; /* same as map */
                overflow-y: scroll;     
                overflow-x: hidden;
                display: block;  
            }

            #mainDropPointListArea.showPreferredDroppoints #dropPointList {
                width: 60%;
                float: left;
               
            }

            #mainDropPointListArea .preferredDroppoints {
               display: none;          
            }

            #mainDropPointListArea.showPreferredDroppoints .preferredDroppoints {
                width: 37%;
                float: right;   
                overflow-x: hidden;    
                display: block;        
            }

            .preferredDroppoints h3 {
                margin-top: -4px 10px;
                font-size: 20px;
            }

            .noscroll {
                xoverflow: hidden;
            }

            #mainDropPointListArea .preferredDroppoints h3 {
                margin-top: 4px 10px;
                font-size: 20px;
            }

            #locateme {
                bottom: 40px;
                right: 40px;
                z-index: 2;
                position: absolute;
                display: none;
            }

            #dropPointDetails {
                position: absolute;
                z-index: 1;
            }

            #droppoint_overlay {
                background: rgba(0, 0, 0, 1);
                position: absolute;
                top: 0;
                left: 0;
                width: 240px;
                border-right: 1px solid #b9b9b9;
                padding: 5px 15px 15px 15px;
                /*font-family:gotham_bookregular;*/
                color: silver;
                float: left;
                /*overflow-y: scroll;*/
            }

            #droppoint_overlay .dp-day-name {
                color: white;
            }

            #droppoint_overlay_close {
                position: absolute;
                top: 32px;
                right: 32px;
                margin-top: -28px;
                margin-right: -20px;
            }

            #droppoint_overlay gfs-checkout {
                margin: auto;
                width: 80%;
            }

            #droppoint-delivery-options {
                clear: both;
            }

            #toggleDropPointsViewControls {
                display: flex;
                margin: 0 0 20px;
            }

            #mapTools, #listTools {
                display: flex;
                flex-direction: row;
            }

            #viewAsList, #viewAsMap {
                margin-top: 19px;
            }

            .toggle-label {
                display: inline-block;
                font-size: 18px;
                margin-right: 0.4em;
            }

            .fade-in {
                opacity: 0.8;
                transition: opacity 400ms ease-in;
                z-index: 2;
            }

            .fade-out {
                opacity: 0.0;
                transition: opacity 400ms ease-in;
                z-index: 0 !important;
            }

            #droppoint_info {
               
                overflow-y: hidden;
            }



            #droppoint_info a,
            #droppoint_info a:visited,
            #droppoint_info a:active {
                text-decoration: none;
                color: #29a54f;
                font-size: 11px;
                /*font-family: 'gotham_bookregular';*/
                font-weight: bold;

            }

            a.droppoint_info:hover {
                text-decoration: underline;
            }

            .highlight {
                color: #FFFFFF !important;
                background-color: #90dca7 !important;
            }

            .toggle-content {
                padding-left: 2px;
            }

            .cardList {
                display: flex;
                flex-direction: column;
                xflex-wrap: wrap;
                height: 630px;
                overflow-x: hidden;
                overflow-y: scroll;
            }

            div.dark .open-late {
                -webkit-filter: invert(1);
                filter: invert(1);
            }

            div#gfsMapCanvas .loading {
                margin: auto;
                width: 100px;
                padding-top: 120px;
            }

            paper-spinner#map-spinner {
                width: 100px;
                height: 100px;
            }

            div.cardList .loading {
                margin: auto;
                width: 100px;
                padding-top: 50px;
            }

            paper-spinner#list-spinner {
                width: 100px;
                height: 100px;
            }


            /* mp customization */


            .dp-card-margin {
                margin: 0 20px 0 0;
            }

            .dp-card-margin:nth-child(2n+1) {
                margin-right: 0;
            }

            h3.carrier-name {
                font-size: 20px;
                margin: 0;
            }

            ul.carrier-list {
                margin-bottom: 10px;
            }

            ul.carrier-list:last-child {
                margin-bottom: 5px;
            }

            li.gfsStd label, li.delivery-place label {
                margin-top: 3px;
            }

            li.delivery-place label {
                margin-bottom: 0;
            }

            #calendarPanel {
                padding: 15px;
            }

            #calendar-delivery-options {
                margin-left: 25px;
                width: 90%;
            }

  
            span.gfsmethodname {
                margin: 3px 0 0;
            }

            .toggle-content {
                margin-top: 0;
                /*padding: 10px 0 0 18px;
                border-top: 1px solid #ccc;
                border-bottom: 1px solid #ccc;*/
            }

            .header {
                padding: 0 10px;
                line-height: 50px;
            }

            .header h3:hover {
                cursor: pointer;
            }

            .header {
                background: #fafafa;
                margin: 0 0 15px;
                padding-top: 5px;
                border: 1px solid #fafafa;
                box-shadow: 0 0 1px 0 rgba(0, 0, 0, 0.1), 0 0 1px 0 rgba(0, 0, 0, 0.1), 0 1px 1px -1px rgba(0, 0, 0, 0.2);
            }

            .header label h3 {
                margin-bottom: 0;
                padding: 0 0 0 5px;
                display: inline-block;
            }

            div.header:last-child {
                margin: 0;
            }

            .selected-radio-options {
                transition: all .2s ease-in-out;
                transform: scale(1.01);
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                /*box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 4px -3px rgba(0, 0, 0, 0.2)*/
            }
            /*
            .droppoint-margin {
                margin-right: 20px;
                position: relative;
            }

            .droppoint-margin:nth-child(2n+1) {
                margin-right: 0;
            }
            */

            #gfsMapCanvas {
                margin: 0 0 20px;
                position: relative;
            }

            paper-spinner#standard-spinner {
                width: 100px;
                height: 100px;
                position: relative;
                left: 50%;
                margin-left: -50px;
            }

            paper-spinner#calendar-spinner {
                width: 100px;
                height: 100px;
                position: relative;
                left: 50%;
                margin-left: -50px;
            }

            paper-spinner#search-spinner {
                width: 100px;
                height: 100px;
                margin-top: -50px;
                margin-left: -50px;
                top: 50%;
                left: 50%;
            }

            :root {
                --paper-tabs-selection-bar-color: blue;
            }

            #gfsMapCanvas-loading {
                background: rgba(0, 0, 0, .8);
                width: 100%;
                height: 90%;
                position: absolute;
                z-index: 100;
            }

            .search-postcode-wrap {
                display: flex;
                flex-direction: row;
            }

            #droppointAddress {
                display: inline-block;
                margin-top: 10px;
                margin-left: 10px;
                padding: 0px 5px 0px 5px;
                height: 41px;
            }

            #wrongPostoce { /* TODO: Check if this is a typo */
                color: #d60000;
            }

            #errorNotification {
                --paper-toast-background-color: red;
                --paper-toast-color: white;
            }

            .gfs-button {
                margin: 10px;
                padding: 10px;
                background-color: rgba(200, 200, 200, 1.0);
                color: #000000;
                border-radius: 4px;
                text-align: center;
                cursor: pointer; 
                min-width: 100px;
            }

            .gfs-button:hover {
                background-color: rgba(68, 144, 68, 1.0);
                color: #FFFFFF;
                transition-duration: 0.5s;
            }

            .gfs-button.disabled {
                background-color: rgba(200, 200, 200, 0.5);
                cursor: not-allowed;
            }

            /*
                .gfs-button.small-button {
                    width: 100px;
                    padding: 5px 10px 5px 10px;
                }
            */

            .gfs-button.search-button {
                width: 100px;
                margin-left: 0px;

                border-bottom-left-radius: 0px;
                border-top-left-radius: 0px;
            }   
            
            paper-tab {
                --paper-tabs-selection-bar-color: blue;
            }        

            @media (max-width: 493px) {
                .header label h3 {
                    font-size: 21px;
                }

                #locateme {
                    width: 55px;
                    right: 10px;
                    bottom: 20px;
                    display: block;
                }
            }

            @media (max-width: 475px) {
                .header label h3 {
                    font-size: 19px;
                }

                .cardList {
                    width: 100%;
                    height: 380px;
                    overflow-x: scroll;
                    overflow-y: hidden;
                    flex-direction: column;
                }

                .cardList .droppoint-margin {
                    margin-right: 35px;
                }
            }

            @media (max-width: 440px) {

                .header label h3 {
                    font-size: 16px;
                }
            }

            @media (max-width: 389px) {
                .header label {
                    max-width: 90%;
                    line-height: initial;
                    vertical-align: middle;
                }
            }
        </style>

        <iron-ajax id="ajaxPost"
                   method="POST"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handlePostResponse"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="ajaxGet"
                   method="GET"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handleGetResponse"
                   on-error="_handleError"
                   timeout="10000"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="ajaxPatch"
                   method="PATCH"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handlePatchResponse"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="ajaxGetDroppoints"
                   method="GET"
                   handle-as="json"
                   content-type="application/json"                
                   on-response="_handleGetDroppointsResponse"
                   on-error="_handleGetDroppointsError"
                   debounce-duration="300">
        </iron-ajax>

        <map-region-manager id="regionManager"></map-region-manager>

		<div id="widgetContainer">

            <paper-tabs selected="{{selectedTab}}">
                <paper-tab>{{standardDeliveryTitle}}</paper-tab>
                <paper-tab>{{calendarDeliveryTitle}}</paper-tab>
                <paper-tab>Click and Collect</paper-tab>
            </paper-tabs>
            <iron-pages id="pages" selected="{{selectedTab}}"  on-iron-select="onSelectTab">
                <iron-page id="pageStandard">
                    <div id="standard-loading" class="loading"><paper-spinner active id="standard-spinner"></paper-spinner></div>
                    <ul class="separated">
                        <template is="dom-repeat" items="{{standardRates}}" sort="sortServices">
                            <li class="gfsStd">
                                <input name="shipping_method" on-click="updateDeliveryOptionsEvent" type="radio" checked="{{item.selected}}" value="{{item.id}}" id="{{item.id}}" class="radio standard-delivery-selection" />
                                <label for$="{{item.id}}">
                                    <span class="methodname">{{item.methodTitle}}</span>
                                    <span class="price">{{currencySymbol}}{{item.price}}</span>
                                    <span>{{item.deliveryDateRange}}</span>
                                </label>
                            </li>
                        </template>
                    </ul>            
                </iron-page>
                <iron-page id="pageCalendar">
                    <div id="calendar-loading" class="loading">
                        <paper-spinner active id="calendar-spinner"></paper-spinner>
                    </div>
                    <div class="row">
                        <div>
                            <brick-calendar id="calendar-widget" class="gfs-checkout xhidden" controls first-weekday-num=0></brick-calendar>
                            <!-- Clicking on a day in the calendar sets _selectedDayDeliveries -->
                        </div>
                        <div>
                            <div id="calendar-delivery-options" class="hidden">
                                <h4>{{calendarDayPrompt}}</h4>
                                <ul class="separated">
                                    <template is="dom-repeat" items="{{_selectedDayDeliveries.deliveries}}" sort="sortDayDefiniteServices">

                                        <li class="delivery-place">
                                            <input type="radio"
                                                    name="shipping_method"
                                                    value="{{item.id}}"
                                                    id="{{item.id}}"
                                                    checked="{{item.selected}}"
                                                    on-click="updateDayDeliveryOptionsEvent"
                                                    class="radio calendar-delivery-selection" />
                                            <span class="gfsmethodname">
                                                {{item.methodTitle}}
                                                <span class="price">{{currencySymbol}}{{item.price}}</span>
                                            </span>
                                        </li>

                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>
 
                </iron-page>
                <iron-page id="pageDroppoints">
                    <div class="page" id="pageDroppoints">

                        <div class="header" style="display:none">
                            <h3>{{dropPointTitle}}</h3>
                        </div>

                        <div class="gfsDropPoint" id="mapContainer">
                            <div id="mapTools">
                                <div class="search-postcode-wrap">
                                    <div class="gfs-button small-button" on-click="showPage_Standard">< Back</div>
                                    <input type="text" id="droppointAddress" placeholder="Find alternative postcode" />
                                    <div type="submit" id="droppointSubmit" class="gfs-button search-button" on-click="_findPostcode">Find</div>
                                    <div id="wrongPostoce"></div>
                                </div>

                                <div id="toggleDropPointsViewControls">
                                    <a href="#" id="viewAsList" on-tap="_toggleDroppointView">View as a list</a>
                                </div>

                            </div>

                            <div id="dropPointDetails" class$="{{_dropPointDetailsClass}}">
                                <div id="droppoint_overlay" style="height: {{mapHeight}}px; display: block">
                                    <div id="droppoint_overlay_close" on-click="_hideDropPointDetails">
                                        <img src="./images/x.png" alt="close" />
                                    </div>
                                    <gfs-droppoint id="overlay-droppoint" click-to-choose="true" droppoint-data="{{_selectedDropPoint}}" disable-unchoose="true" on-click="_hideDropPointDetails" container-class="overlay" show-distance="true" show-opening-hours="true"></gfs-droppoint>
                                </div>
                            </div>
                            <div class="hidden">
                                <div id="droppoint_info" class="noscroll">
                                    <gfs-droppoint show-opening-hours-link="true" click-to-choose="true" on-opening-hours-link-click="_showDropPointDetails" disable-unchoose="true" id="infobox-droppoint" droppoint-data="{{_selectedDropPoint}}" on-select-delivery-option="onUpdateDroppointDeliveryOptions" show-shipping-options="true" button-type="tick"></gfs-droppoint>
                                </div>
                            </div>
                            <img id='locateme' on-click="_locateMe" src='./images/locateme.png' />
                            <div id="gfsMapCanvas-loading" class="loading"><paper-spinner id="search-spinner"></paper-spinner></div>
                            <div id="mainMapArea">
                                <div id="gfsMapCanvas">
                                    <div class="loading">
                                        <paper-spinner active id="map-spinner"></paper-spinner>
                                    </div>
                                </div>
                                <div class="preferredDroppoints">
                                    <h3>My Collection Points</h3>
                                    <template id="mapPreferredDropPointList" is="dom-repeat" items="{{_preferredDroppoints}}" sort="sortByDistance">
                                        <gfs-droppoint click-to-choose="true" xon-select="_onSelectPreferredDroppoint" container-class="dp-mini-card" xon-droppoint-click="_onClickDroppoint" button-type="tick" disable-unchoose="true" droppoint-data="{{item}}" class="droppoint"></gfs-droppoint>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <array-selector id="dropPointSelector" items="{{_dropPoints}}" selected="{{chosen}}" multi="false"></array-selector>
                        <div id="dropPointListContainer" class="hidden">
                            <div id="listTools">
                                <div class="gfs-button small-button" on-click="showPage_Standard">< Back</div>
                                <a href="#" id="viewAsMap" on-tap="_toggleDroppointView">View as a map</a>
                            </div>
                            <div id="dropPointText">
                                <gfs-droppoint-text selected-droppoint="{{_selectedDropPoint}}"></gfs-droppoint-text>
                            </div>

                            <div class="cardList">
                                <div id="list-loading" class="loading">
                                    <paper-spinner active id="list-spinner"></paper-spinner>
                                </div>
                                <div id="mainDropPointListArea">
                                    <div id="dropPointList">
                                        <template id="dropPointListTemplate" is="dom-repeat" items="{{_dropPoints}}" sort="sortByDistance">
                                            <gfs-droppoint on-select-delivery-option="onUpdateDroppointDeliveryOptions" disable-unchoose="true" scroll-into-view-on-choose="true" show-shipping-options="true" show-opening-hours="true" show-distance="true" container-class="dp-large-card" button-type="standard" droppoint-data="{{item}}" class="droppoint"></gfs-droppoint>
                                        </template>
                                    </div>

                                    <div class="preferredDroppoints">
                                        <h3>My Collection Points</h3>
                                        <template id="listPreferredDropPointList" is="dom-repeat" items="{{_preferredDroppoints}}" sort="sortByDistance">
                                            <gfs-droppoint on-select="_onSelectPreferredDroppoint" container-class="dp-mini-card" disable-unchoose="true" button-type="tick" droppoint-data="{{item}}" class="droppoint"></gfs-droppoint>
                                        </template>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </iron-page>
            </iron-pages>
        </div>
        <input type="text" value="{{_selectedDropPoint.droppointId}}" id="dropPointRadio" class="hidden" />
        <paper-toast id="errorNotification" class="fit-bottom"></paper-toast>
    </template>

    <script>
        /* Warning message goes here */
        /*global Polymer*/
        var DAY_MS = 1000 * 60 * 60 * 24;
        var DOW_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun', '?'];
        var MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        // set them here so you can access the home marker
        var geocoder = null;
        var marker = null;

        // element registration
        Polymer({
            is: "gfs-checkout",

            // add properties and methods on the element's prototype

            properties: {
                //=== Element attributes ===//
                accessToken: {
                    type: String
                },

                currencySymbol: {
                    type: String,
                    value: '£'
                },

                gfsData: {
                    type: String
                },

                useDropPoints: {
                    type: Object,
                    value: true
                },

                useStandard: {
                    type: Object,
                    value: true
                },

                useCalendar: {
                    type: Object,
                    value: true
                },

                calendarLabels: {
                    type: Object,
                    value: {
                        //prev: "<<",
                        //next: ">>",
                        months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                        weekdays: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"]
                    }
                },

                allowCalendarPreselect: {
                    type: Object,
                    value: true
                },

                initialAddress: {
                    type: String
                },

                // ATTRIBUTES
                //
                // These properties represent text used for labels, titles and prompts throughout the widget.
                // They are controlled by passing values via the element attributes.
                // To override the default values shown below, simply pass through the attributes name, with camel caps converted to dashed lower case:
                // e.g: 'dropPointTitle' would be set by:
                // <gfs-checkout drop-point-title="Your text goes here" ...

                dropPointTitle: {
                    type: String,
                    value: 'Would you prefer to collect your order?'
                },

                dropPointDeliveryTitle: {
                    type: String,
                    value: 'Select your preferred collection point to view available services:'
                },

                calendarDeliveryTitle: {
                    type: String,
                    value: 'Calendar Delivery'
                },

                calendarDayPrompt: {
                    type: String,
                    value: 'Please select a delivery time:'
                },

                standardDeliveryTitle: {
                    type: String,
                    value: 'Standard Delivery'
                },

                // Change the value of the default-delivery where the <gfs-checkout> element is loaded: default-delivery="your_option_here"
                // set default delivery option => Standard, Express or CollectionPoint
                defaultDelivery: {
                    type: String,
                    value: 'Standard'
                },

                hideMapUI: {
                    type: Object,
                    value: false
                },

                mapHeight: {
                    type: Number,
                    value: 400
                },

                homeIcon: {
                    type: String
                },

                markerIcon: {
                    type: String
                },

                selectedMarkerIcon: {
                    type: String
                },

                //TODO: Investigate removing these
                /*startingLatitude: {
                	type: Number,
                	value: 37.4220279
                },

                //TODO: Investigate removing these
                startingLongitude: {
                	type: Number,
                	value: -122.0840677
                },*/

                startingZoomLevel: {
                    type: Number,
                    value: 14
                },

                serviceSortOrder: {
                    type: String, //cheapestFirst, fastestFirst, expensiveFirst, slowestFirst
                    value: "cheapestFirst"
                },

                selectedServiceDetails: {
                    type: Object,
                    value: {
                        service: null,
                        serviceCode: null,
                        carrier: null,
                        shipping: null,
                        deliveryAddress: null,
                        expDeliveryDateStart: null,
                        expDeliveryDateEnd: null,
                        collectPoint: null
                    }
                },

                // PRIVATE PROPERTIES
                //
                // Do not modify these properties.

                _droppointOpened: {
                    type: Boolean,
                    value: false
                },

                _autoChooseCollectionPoint: {
                    type: Object,
                    value: true
                },

                _selectedDropPoint: {
                    type: Object
                },

                _dropPointDetailsClass: {
                    type: String,
                    value: "hidden"
                },



                _shippingRateGroups: {
                    type: Array,
                    notify: true,
                    value: []
                },

                _data: {
                    type: Object,
                    value: {
                        dayDefinite: [],
                        droppoints: [],
                        standardRates: [],
                        links: [],
                        nonDayDefinite: []
                    }
                },

                _dropPoints: {
                    type: Array,
                    value: [],
                    notify: true
                },

                _preferredDroppoints: {
                    type: Array,
                    value: []
                },

                _map: {
                    type: Object
                },

                _currentMarker: {
                    type: Object
                },

                _dropPointTickClass: {
                    type: String,
                    value: "notchosen"
                },

                _dropPointChooseBtnText: {
                    type: String,
                    value: "Choose"
                },

                _showingDroppoints: {
                    type: Object,
                    value: false
                },

                _showingDroppointsMap: {
                    type: Object,
                    value: true
                },

                _showingDroppointsList: {
                    type: Object,
                    value: false
                },

                _infoWindow: {
                    type: Object
                },

                //Lookup for deliveries on a given day
                _deliveryDays: {
                    type: Object,
                    value: {}
                },

                //Lookup for deliveries on a given day
                _deliveryDroppoints: {
                    type: Object,
                    value: {}
                },

                _earliestDelivery: {
                    type: Object,
                    value: null
                },

                _infoBoxDroppoint: {
                    type: Object
                },

                // set default service parameters when API is not available
                defaultService: {
                    type: String,
                    value: ""
                },

                defaultCarrier: {
                    type: String,
                    value: ""
                },

                defaultPrice: {
                    type: String,
                    value: ""
                },

                defaultMinDeliveryTime: {
                    type: String,
                    value: ""
                },

                defaultMaxDeliveryTime: {
                    type: String,
                    value: ""
                },

                defaultCarrierCode: {
                    type: String,
                    value: ""
                }

            },

            listeners: {
                "datetoggleon": "_deliveryDateSelected",
                "prevmonth": "_calendarMonthChanged",
                "nextmonth": "_calendarMonthChanged",
                "droppoint-changed": "_droppointChanged"
            },

            // METHODS

            // This function is called as soon as the widget is ready
            ready: function() {
                var theJson = atob(this.gfsData);
                theJson = theJson.replace(/\r?\n|\r/g, "");
                actualPost = JSON.parse(theJson);
                this.countryCode = actualPost.Request.Order.Transit.Recipient.Location.CountryCode.Code;
                this.postCode = actualPost.Request.Order.Transit.Recipient.Location.Postcode;

                if (this.accessToken === "") {
                    this.$.errorNotification = "No Access Token.. ";
                    this.$.errorNotification.show();
                } else {
                    this.$.ajaxPost.url = "///rest.api.checkout.justshoutgfs.com/api/CheckoutSession";
                    this.$.ajaxPost.body = actualPost;
                    console.log("Initial POST", new Date().getTime());
                    this.$.ajaxPost.headers = this._computeHeader();
                    this.$.ajaxPost.generateRequest();

                    if (this.defaultDelivery === '') { // set Standard delivery if none is supplied
                        this.defaultDelivery = 'Standard';
                    }

                    // check which is the default delivery option
                    switch (this.defaultDelivery) {
                        case 'Standard':
                            this.showPage_Standard();
                            //this.$.standardDeliveryPanel.opened = true;
                            break;
                        case 'Express':
                            this.showPage_Standard();
                            //this.$.calendarPanel.opened = true;
                            break;
                        case 'CollectionPoint':
                            this.showPage_Droppoints();                       
                            break;
                    }
                }
            },

            _computeHeader: function () {
                return {
                    "Authorization": "Bearer " + atob(this.accessToken)
                };
            },

            _handlePostResponse: function(e) {
                // console.log("Followup GET", new Date().getTime());
                this._sessionId = e.detail.response.substring(e.detail.response.lastIndexOf("/") + 1);
                this.$.ajaxGet.url = "///rest.api.checkout.justshoutgfs.com/api/CheckoutSession/" + this._sessionId;
                this.$.ajaxGet.headers = this._computeHeader();

                //console.log('sessionID', this._sessionId);
                this.$.ajaxGet.generateRequest();
            },

            _handleGetResponse: function(e) {
                this.$$('#list-spinner').active = false;
                this.$$('#list-loading').classList.add('hidden');
                this.$$('#standard-loading').classList.add('hidden');

                this.$$('brick-calendar').classList.remove('hidden');
                this.$$('#calendar-loading').classList.add('hidden');
                this.$$('#calendar-delivery-options').classList.remove('hidden');

                this.$$("#gfsMapCanvas-loading").classList.add('hidden');
                if (this.$$("#map-spinner")) {
                    this.$$("#map-spinner").classList.add('hidden');
                }

                var useWebService = true; //false;
                if (useWebService) {
                    this._data = e.detail.response;
                }
                else if (typeof (this.gfsData) === "string") {
                    var unencoded = atob(this.gfsData);
                    this._data = JSON.parse(unencoded);
                }
                this._dropPoints = this._data.droppoints;
                this._requestDroppointList(this._preferredDroppoints);

                window.setTimeout(this._delayedInit.bind(this), 0);
            },

            _handleError: function (e) {
                console.error("GFS Checkout Error", e);
                console.warn("Using default shipping");
                //zzz
                // hide all services except standard
                /*
                this.$$("#calendarDeliveriesOption").parentNode.classList.add("hidden");
                this.$$("#dropPointDeliveriesOption").parentNode.classList.add("hidden");
                this.$$('#standard-loading').classList.add('hidden');
                this.$.standardDeliveriesOption.checked = "checked";*/

                // create an array for polymer
                this.standardRates = [];
                var today = new Date();
                var startDate = new Date(today);
                startDate.setDate(startDate.getDate() + parseInt(this.defaultMinDeliveryTime));
                var endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + (this.defaultMaxDeliveryTime - 1));

                this.standardRates = [{
                    id: -3,
                    methodTitle: this.defaultService,
                    price: this.defaultPrice,
                    deliveryDateRange: this._formatNonDayDefiniteDate(startDate, endDate),
                    selected: true,
                    carrier: this.defaultCarrier
                }];

                var method = this.standardRates.shift()
                this.selectedServiceDetails.serviceId = method.id;
                this.selectedServiceDetails.service = this.defaultService;
                this.selectedServiceDetails.serviceCode = this.defaultCarrierCode;
                this.selectedServiceDetails.carrier = this.defaultCarrier;
                this.selectedServiceDetails.shipping = this.defaultPrice;
                this.selectedServiceDetails.expDeliveryDateStart = startDate;
                this.selectedServiceDetails.expDeliveryDateEnd = endDate;

                this.selectedServiceDetails.deliveryAddress = actualPost.Request.Order.Transit.Recipient.Location;

                this.fire('selectedservicechanged', this.selectedServiceDetails);
                this._resetMap();

            },

            _handlePatchResponse: function (e) {
                this.fire("close-checkout-complete", e.detail.response);
            },

            _handleGetDroppointsResponse: function(e) {
                //New droppoint data
                this._data = e.detail.response;
                //this._data.droppoints = this._processDroppointList(this._data.droppoints);
                this._dropPoints = this._dropPoints.concat(this._data.droppoints);
                this._processAllDroppoints();
                this._findAllDeliveryDroppoints();
                this._loadDroppointMarkers(this._data.droppoints);

                //TODO: Replace this with a method or event; we want to avoid referencing the View from logic code
                this.$$("#gfsMapCanvas-loading").classList.add('hidden'); // map search spinner
            },

            _handleGetDroppointsError: function (e) {
                this._resetMap()
                this._loadDroppointMarkers(this._data.droppoints);
            },

            _delayedInit: function() {
                //console.log("_delayedInit", new Date().getTime());
                this._processInputData();

                if (this.useDropPoints) {
                    this._makeMap();
                    this._findAllDeliveryDroppoints();
                    this._processAllDroppoints();
                }
                if (this.useCalendar) {
                    this._makeCalendar();
                }
                this._checkForServices(this.defaultDelivery);
                //this._preselect();
            },

            _apiKeyChanged: function(newValue, oldValue) {
                console.log('API Key changed to', newValue);
            },

            isNonGfs: function(item) {
                return item.carrierCode !== 'gfs';
            },

            isGfs: function(item) {
                return item.carrierCode === 'gfs';
            },

            _processInputData: function () {
                this._processDayDefiniteData();
                this._processNonDayDefiniteData();
            },

            _checkForServices: function (defaultDelivery) {
                //Preselect delivery option based on default delivery method
                if ((defaultDelivery === 'Standard') && (this._data.standardRates.length !== 0)) {
                    this.showPage_Standard();
                    this._preselectForStandard();
                }
                else if (this._data.standardRates.length === 0) {
                    this.$$("#standardDeliveriesOption").parentNode.classList.add("hidden");
                }

                //Commented out
                //TODO: Hide options when there are no services available
                /*
                if ((defaultDelivery === 'Standard') && (this._data.standardRates.length !== 0)) {
                    this.$.standardDeliveryPanel.opened = true;
                    this.$.standardDeliveriesOption.checked = "checked";
                    this.$.calendarDeliveriesOption.checked = "";
                    this.$.dropPointDeliveriesOption.checked = "";
                    this._preselectForStandard();
                }
                else if (this._data.standardRates.length === 0) {
                    this.$$("#standardDeliveriesOption").parentNode.classList.add("hidden");
                }

                if (((defaultDelivery === 'Express') || (this._data.standardRates.length === 0)) && (this._data.dayDefinite.length !== 0)) {
                    if (this._data.standardRates.length === 0)
                        this.$$("#standardDeliveriesOption").parentNode.classList.add("hidden");

                    this.$.calendarPanel.opened = true;
                    this.$.standardDeliveriesOption.checked = "";
                    this.$.calendarDeliveriesOption.checked = "checked";
                    this.$.dropPointDeliveriesOption.checked = "";
                    this._preselectForExpress();
                }
                else if (this._data.dayDefinite.length === 0) {
                    this.$$("#calendarDeliveriesOption").parentNode.classList.add("hidden");
                }*/

                /*

                var deliveryDroppointsSize = Object.keys(this._deliveryDroppoints).length;
                if (((defaultDelivery === 'CollectionPoint') || (this._data.dayDefinite.length === 0)) && (deliveryDroppointsSize !== 0)) {
                    this._autoChooseCollectionPoint = true;
                    if ((this._data.standardRates.length === 0) && (this._data.dayDefinite.length === 0)) {
                        this.$$("#standardDeliveriesOption").parentNode.classList.add("hidden");
                        this.$$("#calendarDeliveriesOption").parentNode.classList.add("hidden");
                    }

                    this.$.dropPointPanel.opened = true;
                    this.$.standardDeliveriesOption.checked = "";
                    this.$.calendarDeliveriesOption.checked = "";
                    this.$.dropPointDeliveriesOption.checked = "checked";
                }
                else if (deliveryDroppointsSize === 0) {
                    this.$$("#dropPointDeliveriesOption").parentNode.classList.add("hidden");
                }*/
            },


            sortByDistance: function (a, b) {
                if (a.chosen) return -1
                else if (b.chosen) return 1
                else if (a === b) return 0;
                else return a.distanceInMeters < b.distanceInMeters ? -1 : 1;
            },

            getClosestDroppoint: function (dpList) {
                return dpList.reduce(function (prev, curr) {
                    return (prev.distanceMeters < curr.distanceInMeters) ? prev : curr;
                });
            },

            sortServices: function (a, b) {
                if (a == b) return 0;

                switch (this.serviceSortOrder) {
                    case "cheapestFirst":
                        return a.price < b.price ? -1 : 1;
                    case "fastestFirst":
                        return a.deliveryTimeFrom < b.deliveryTimeFrom ? -1 : 1;
                    case "expensiveFirst":
                        return a.price > b.price ? -1 : 1;
                    case "slowestFirst":
                        return a.deliveryTimeFrom > b.deliveryTimeFrom ? -1 : 1;
                    default:
                        return;
                }
            },

            sortDayDefiniteServices: function (a, b) {
                if (a == b) return 0;

                switch (this.serviceSortOrder) {
                    case "expensiveFirst":
                        return a.price > b.price ? -1 : 1;
                    case "cheapestFirst":
                    case "fastestFirst":
                    case "slowestFirst":
                    default:
                        return a.price < b.price ? -1 : 1;
                }
            },


            setPreferredDroppoints: function (droppointList) {
                var self = this;
                this._preferredDroppoints = droppointList;//.filter(function (item) { return true });
                this._processPreferredDroppoints();

                if (this._preferredDroppoints.length > 0) {             
                    this._showPreferredDroppoints();
                }
               
            },

            _processAllDroppoints: function () {
                this._removeDupDropPoints();
                this._addDropPointDeliveries();
                this._processPreferredDroppoints();
            },

            _removeDupDropPoints: function () {
                var self = this;
                var uniques = [];
                for (var j = 0; j < this._dropPoints.length; j++) {
                    var dp = this._dropPoints[j];
                    if (!uniques.find(function(item) {
                        return item.droppointId == dp.droppointId;
                    })) {
                        uniques.push(dp);
                    }
                }
                this.set('_dropPoints', uniques);
                /*
                this._dropPoints = this._dropPoints.filter(function (item, filterIndex) {
                  
                    if (self._dropPoints.find(function (dp, findIndex) { return filterIndex !== findIndex && dp.droppointId == item.droppointId })) {
                        console.warn("Removing", item.droppointId, filterIndex);
                        return false;
                    }
                    else return true;
                }); */
            },

            _processPreferredDroppoints: function()
            {
                //Now replace preferred items with real data
                var self = this;
                this._preferredDroppoints = this._preferredDroppoints.map(function (item) {
                    var existingItem = self._droppointById(null, item.droppointId);
                    if (existingItem) {
                        existingItem.chosen = item.chosen;
                    }
                    return existingItem || item;
                });
            },

            _addDropPointDeliveries: function()
            {
                var self = this;
                this._dropPoints.forEach(
                    function (item) {
                        item.collectionPoint = true;

                        //TODO: This often seems to return delivery method IDs associated with the wrong provider?
                        item.deliveries = self._findDropPointDeliveries(item.providerId);
                        return item;
                    }
                );
            },
            
            // find the earliest of each service
            _getGroupedByService: function() {
                var self = this;
                var results = [];
                var services = [];

                // find the earliest of each non day definite service
                this._data.nonDayDefinite.forEach(function(day) {
                    day.rates.forEach(function(service) {
                        if (service.serviceType.type === "dmStandard") {
                            if (typeof(services[service.methodTitle]) === "undefined") {
                                services[service.methodTitle] = {
                                    deliveryDate: day.deliveryDate,
                                    service: service
                                };
                            } else {
                                var servicesDay = new Date(services[service.methodTitle].deliveryDate)
                                var nonDayDefiniteDay = new Date(day.deliveryDate);
                                if (servicesDay.getTime() > nonDayDefiniteDay.getTime())
                                    services[service.methodTitle] = {
                                        deliveryDate: day.deliveryDate,
                                        service: service
                                    };
                            }
                        }
                    });
                });

                // create array for display in polymer
                for (var service in services) {
                    var item = services[service];
                    var obj = {
                        id: item.service.id,
                        methodTitle: item.service.methodTitle,
                        price: item.service.price,
                    };
                    // non day definite
                    var startDate = new Date(item.deliveryDate);
                    var endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (item.service.maxDD - 1));
                    obj.deliveryDateRange = this._formatNonDayDefiniteDate(startDate, endDate);
                    obj.deliveryTimeFrom = endDate.getTime();
                    results.push(obj);
                }
                return results;
            },

            _getDeliveryRateById: function(id) {
                var combinedRateGroups = this._data.dayDefinite.concat(this._data.nonDayDefinite);
                var rates = [];
                combinedRateGroups.forEach(function(group) {
                    rates = rates.concat(group.rates);
                });
                var resultList = rates.filter(function(rate) {
                    return rate.id == id
                });
                if (resultList.length) {
                    if (resultList.length > 1) {
                        console.warn("getDeliveryRateById(): Multiple matches");
                    }
                    return resultList[0];
                } else return null;
            },

            _processNonDayDefiniteData: function() {
                if (this._data.nonDayDefinite.constructor === Array && this._data.nonDayDefinite.length > 0) {
                    this._data.standardRates = this._getGroupedByService();
                    this.standardRates = this._data.standardRates;
                }
            },

            _processDayDefiniteData: function() {

            },

            _makeCalendar: function() {
                this.$$('brick-calendar').labels = this.calendarLabels;
                this._findAllDeliveryDays();
                window.setTimeout(this._markDeliveryDays.bind(this), 500);
            },

            _makeMap: function () {
                var self = this;

                var home = null;

                self._infoWindow = new google.maps.InfoWindow({
                    content: self.$.droppoint_info
                });
                //var position = new google.maps.LatLng(self.startingLatitude, self.startingLongitude);

                // map options
                var mapOptions = {

                    // initial zoom level
                    zoom: self.startingZoomLevel,
                    minZoom: self.startingZoomLevel - 2,

                    // initial center position
                    //center: position,

                    // type of map (ROADMAP, SATELLITE, TERRAIN, HYBRID)
                    mapTypeId: google.maps.MapTypeId.TERRAIN,

                    // show or hide streetview control
                    streetViewControl: false,

                    // show or hide the google map UI
                    disableDefaultUI: self.hideMapUI,

                    // map controls (only if disableDefaultUI is false)
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                        position: google.maps.ControlPosition.TOP_RIGHT,
                    },

                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.SMALL,
                        position: google.maps.ControlPosition.TOP_RIGHT
                    },

                    // remove points of interest from the map so as not to interfere
                    styles: [{
                        "featureType": "poi",
                        "elementType": "labels",
                        "stylers": [{
                            "visibility": "off"
                        }]
                    }]
                };

                //var postcode = document.getElementById('shipping:postcode').value; //Improve selection method

                self._map = new google.maps.Map(self.$.gfsMapCanvas, mapOptions);
                window.map = self._map;

                //=== Home marker
                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: this.postCode
                    }
                }, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        //self._map.setCenter(results[0].geometry.location);
                        var homeMarkerConfig = {
                            position: results[0].geometry.location,
                            map: self._map,
                            //animation: google.maps.Animation.DROP,
                            title: 'Home',
                            html: 'Home',
                            icon: self._getHomeIcon()
                        };
                        marker = new google.maps.Marker(homeMarkerConfig);
                        self._map.setCenter(homeMarkerConfig.position);
                        self._loadDroppointMarkers();
                        //self._showDropPointsView();
                        self._resetMap(self._map);
                    } else {

                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                        //TODO: Include this in the template, instead of in code
                        $("#gfsMapCanvas").append("<div style='color: #d60000; margin: 20px auto; text-align: center;'> Postcode <strong>" + self.initialAddress + "</strong> return zero restults </div>");
                    }
                });

                google.maps.event.addListener(self._map, 'bounds_changed', function() {
                    // initialise region manager
                    var bounds = self._map.getBounds();
                    var northEast = [bounds.getNorthEast().lng(), bounds.getNorthEast().lat()];
                    var southWest = [bounds.getSouthWest().lng(), bounds.getSouthWest().lat()];
                    self.$.regionManager.addRegion([northEast, southWest]);
                    console.log("initalise region manager" + bounds);
                    // remove the listener
                    google.maps.event.clearListeners(self._map, 'bounds_changed');
                });

                
            },

            _loadDroppointMarkers: function (dropPointsArray) {
                var self = this;
                if (!dropPointsArray) return;
                //=== Drop point markers
                var marker;
                dropPointsArray.forEach(
					function (pointItem) {
					    var getCountryCode = pointItem.geoLocation.countryCode;
					    var markerConfig = {
					        position: new google.maps.LatLng(pointItem.geoLocation.coordinates.latitude, pointItem.geoLocation.coordinates.longitude),
					        map: self._map,
					        //animation: google.maps.Animation.DROP,
					        title: pointItem.droppointDescription,
					        customData: pointItem,
					        icon: self._droppointIcon(getCountryCode) + '/' + pointItem.providerName + '.png',
					        zIndex: google.maps.Marker.MAX_ZINDEX + 1
					        //icon: url + '/' + pointItem.geoLocation.countryCode + '/' + pointItem.providerName + '.png'
					    };
					    //console.log(pointItem.geoLocation.coordinates.longitude, pointItem.geoLocation.coordinates.latitude);
					    marker = new google.maps.Marker(markerConfig);
					    marker.addListener('click', function (clickedMarker) {
					        self._selectDropPointMarker(this);
					    });
					    // add a link to the marker to get to it from the droppoint, need to animate and centre the marker if selecting from list view
					    pointItem.marker = marker;
					}
				);

                google.maps.event.addListener(self._map, 'click', function(event) {
                    self._unselectDropPoint();
                });

                // 'idle' event is triggered when the user stopped zooming/dragging;
                google.maps.event.addListener(self._map, 'idle', function(event) {
                    //console.log(JSON.stringify(event));
                    self._mapMoved();
                });
            },

            _droppointIcon: function(countryCode) {
                var url = this.resolveUrl('./images/');

                switch (countryCode) {
                    case "DE":
                        return url + '/DE/';
                    case "FR":
                    case "BE":
                    case "ES":
                        return url + '/FR/';
                    default:
                        return url + '/GB/';
                }
            },

            // Geocode service search
            _findPostcode: function () {
                var self = this;
                var address = document.getElementById("droppointAddress").value;
                self.initialAddress = address;
                self.$$("#gfsMapCanvas-loading").classList.remove('hidden');

                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: address
                    }
                }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {

                        self._map.setCenter(results[0].geometry.location);

                        // check if searching for the home location
                        if ((results[0].geometry.location.lat() === marker.getPosition().lat()) && (results[0].geometry.location.lng() === marker.getPosition().lng())) {
                            self.$$("#gfsMapCanvas-loading").classList.add('hidden');
                            self.$.errorNotification.text = "You home location is already at " + address;
                            self.$.errorNotification.fitInto = self.$.gfsMapCanvas;
                            self.$.errorNotification.open();
                        }

                        if (marker && marker.setPosition) {
                            marker.setPosition(results[0].geometry.location);
                        }
                        else {
                            marker = new google.maps.Marker({
                                map: self._map,
                                icon: self._getHomeIcon(),
                                position: results[0].geometry.location
                            });
                        }
                    }

                    else {
                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                        self.$$("#gfsMapCanvas-loading").classList.add('hidden');
                        self.$.errorNotification.text = "Postcode not found";
                        self.$.errorNotification.fitInto = self.$.gfsMapCanvas;
                        self.$.errorNotification.open();
                    }
                });
            },

            _mapMoved: function() {
                var self = this;
                if (self._moveMapTimeout) {
                    window.clearTimeout(self._moveMapTimeout);
                }
                self._moveMapTimeout = window.setTimeout((function() {
                    self._reloadDroppoints();
                }).bind(this), 100);

            },

            // used for trouble shooting
            _drawBoxes: function(boxes, color) {
                var self = this;
                boxes.forEach(function(rect) {
                    var boxCoords = [{
                        lat: rect[0][1],
                        lng: rect[0][0]
                    }, // north west
                        {
                            lat: rect[0][1],
                            lng: rect[1][0]
                        }, // south west
                        {
                            lat: rect[1][1],
                            lng: rect[1][0]
                        }, // south east
                        {
                            lat: rect[1][1],
                            lng: rect[0][0]
                        } // north east
                    ]

                    self._map.data.setStyle({
                        fillColor: color,
                        strokeColor: color,
                        strokeWeight: 2
                    });
                    self._map.data.add({
                        geometry: new google.maps.Data.Polygon([boxCoords])
                    });
                });
            },

            _reloadDroppoints: function() {
                if (this._sessionId) {
                    console.log('reloadDroppoints()');

                    //Get viewport rectangle
                    var bounds = this._map.getBounds();
                    if (!bounds) {
                        console.error("Failed to get map bounds");
                        return;
                    }
                    var northEast = [bounds.getNorthEast().lng(), bounds.getNorthEast().lat()];
                    var southWest = [bounds.getSouthWest().lng(), bounds.getSouthWest().lat()];
                    var viewPort = [northEast, southWest];

                    var boxes = [];

                    this.$.regionManager.getUncoveredRectangles(viewPort).forEach(function (rect) {
                        boxes.push(rect.toGeoBox());
                    });

                    // console.log('Boxes to request:', JSON.stringify(boxes));
                    // self._drawBoxes(boxes, 'green');
                    
                    if (boxes.length > 0) {
                        //console.log("Requesting", boxes.length, "regions");
                        this.$.regionManager.addRegion([northEast, southWest]);
                        this._requestDroppointsByGeoBoxes(boxes);
                    }
                    else {
                        console.log("Not requesting any regions");
                    }
                    this._resetMap(this._map);
                }
            },

            _requestDroppointsByGeoBoxes: function (boxes) {
                //TODO: Make an API component for this
                this.$.ajaxGetDroppoints.url = "///rest.api.checkout.justshoutgfs.com/api/CheckoutSession?sessionId=" + this._sessionId + "&regions=" + JSON.stringify(boxes);
                this.$.ajaxGetDroppoints.headers = this._computeHeader();
                this.$.ajaxGetDroppoints.generateRequest();
            },

            _requestDroppointList: function (droppointList) {
                //NOTE: This is temporary code, to be replaced by a dedicated API endpoint
                if (droppointList.length === 0) return;
                var self = this;
                
                //Make array of geoBoxes, tightly encompassing each droppoint
                var boxes = [];
                droppointList.forEach(function (dp) {
                    boxes.push([[dp.geoLocation.coordinates.longitude - 0.000001, dp.geoLocation.coordinates.latitude - 0.000001], [dp.geoLocation.coordinates.longitude + 0.000001, dp.geoLocation.coordinates.latitude + 0.000001]]);
                });
                this._requestDroppointsByGeoBoxes(boxes);
            },

            _showDropPointDetails: function() {
                this.mapHeight = this.$.gfsMapCanvas.clientHeight;
                this._dropPointDetailsClass = "fade-in";
            },

            _toggleDroppointView: function() {
                this._showingDroppointsList = !this._showingDroppointsList;
                this._showingDroppointsMap = !this._showingDroppointsMap;
                this._showDropPointsView();
            },

            _showDropPointsView: function () {
                var self = this;
                this.fire('show-droppoints');
                if (this._showingDroppointsMap) {
                    //Show droppoints
                    this.$.dropPointListContainer.classList.add('hidden');
                    this.$.mapContainer.classList.remove('hidden');
                    //this._makeMap();
                    this._loadDroppointMarkers(this._dropPoints);
                    //this._fixMapMarker();                       
                                          
                    this._resetMap(this._map);
                }
                else {
                    this.$.dropPointListContainer.classList.remove('hidden');
                    this.$.mapContainer.classList.add('hidden');
                    this._resetMap(this._map);
                }

            },

            _resetMap: function (map) {
                var self = this;
                if (map) {
                    window.setTimeout(function () {
                        google.maps.event.trigger(map, 'resize');
                    }, 100);
                }

                
            },

            _hideDropPointDetails: function() {
                this._dropPointDetailsClass = "fade-out";
            },

            _showPreferredDroppoints: function () {
                this.$.mainMapArea.classList.add("showPreferredDroppoints");
                this.$.mainDropPointListArea.classList.add("showPreferredDroppoints");
                var self = this;
                this._resetMap(this._map);
               // alert('done');
                //self._map.checkResize();
            },

            _getHomeIcon: function() {
                if (this.homeIcon) {
                    return this.homeIcon;
                } else {
                    return this.resolveUrl('./images/home.png');
                }
            },

            //Select a drop point marker
            _selectDropPointMarker: function (marker) {
                this.selectDropPoint(marker.customData.droppointId);
                //marker.customData.chosen = true;
                //this.fire("droppoint-changed", marker.customData);
            },

            selectDropPoint: function(dropPointId) {
                //Select the drop point, if it is known.
                var dp = this._droppointById(null, dropPointId);
                if (dp) {
                    this.set("_selectedDropPoint", dp);
                    this.set('_selectedDropPoint.chosen', true);
                    this.fire("droppoint-changed", dp);
                }
                else {
                    console.log("Couldn't find droppoint", dropPointId);
                }
            },

            _unselectDropPoint: function() {
                if (this._selectedDropPoint) {
                    if (this._infoWindow) {
                        this._infoWindow.close();
                    }
                    this._hideDropPointDetails();
                    this._selectedDropPoint.chosen = false;
                    this._selectedDropPoint = null;
                }
            },

            _chooseDroppointEvent: function (e) {
                this.chooseDroppoint(e.detail);
            },

            chooseDroppoint: function(droppoint) {
                this.chooseDropPointId(droppoint.droppointId);
            },

            chooseDropPointId: function(droppointId) {
                var dp = this._droppointById(null, droppointId);
                if (dp) {
                    this.selectDropPoint(droppointId);
                    this.set('_selectedDropPoint.chosen', true);
                    this.fire("droppoint-changed", this._selectedDropPoint);
                }
            },

            _fixMapMarker: function () {
                if (this._showingDroppointsMap && this._selectedDropPoint) {
                    var dp = this._droppointById(this._selectedDropPoint.providerId, this._selectedDropPoint.droppointId);
                    if (dp) {
                        this._currentMarker = dp.marker;
                    }
                    else {
                        //Make a marker
                        this._loadDroppointMarkers([this._selectedDropPoint]);
                        this._currentMarker = this._selectedDropPoint.marker; //this._droppointById(this._selectedDropPoint.providerId, this._selectedDropPoint.droppointId).marker;
                    }
                    console.log("### Opening info box");
                    this._infoWindow.open(this._map, this._currentMarker);

                    this.$.dropPointRadio.setAttribute('checked', 'true');
                    this._map.panTo(this._currentMarker.getPosition());
                }
            },

            _droppointChanged: function(e) {
                console.log('_droppointChanged', e.detail);
                var changedDroppoint = e.detail;

                if (this._selectedDropPoint)
                    if (changedDroppoint.droppointId !== this._selectedDropPoint.droppointId)
                        this._unselectDropPoint();

                this.set("_selectedDropPoint", changedDroppoint);
                this.$.dropPointListTemplate.render(); //Re-sort the list of drop point cards
                //this.$.listPreferredDropPointList.render(); //Re-sort the preferred list
                this._fixMapMarker();            
            },

            _droppointById: function (providerId, droppointId) {
                if (!this._dropPoints) {
                    return;
                }
                for (var i = 0; i < this._dropPoints.length; i++) {
                    if (/*(this._dropPoints[i].providerId === providerId) && */(this._dropPoints[i].droppointId === droppointId)) {
                        return this._dropPoints[i];
                    }
                }
            },


            _locateMe: function() {
                var self = this;
                // Try HTML5 geolocation.
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            var pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            self._map.setCenter(pos);

                        },
                        function() {
                            handleLocationError(true, self._infoWindow, GMap.getCenter());
                        }
                    );
                } else {
                    // Browser doesn't support Geolocation
                    //handleLocationError(false, infoWindow, GMap.getCenter());
                }
            },

            // _preselect: function () {
            // 	//Find the cheapest option
            // 	//If cheapestCalendar option, also search the calendar for the cheapest option
            // 	//Find cheapest standard option
            // 	return;
            // 	var self = this;
            // 	var cheapestMethod = null;
            // 	var preselectDay = false;
            // 	var items = this._data.standardRates; //nonDayDefinite;//.filter(self.isGfs);
            // 	items.forEach(function (carrier) {
            // 		carrier.rates.forEach(function (item) {
            // 			if (cheapestMethod === null || (item.price < cheapestMethod.price)) {
            // 				cheapestMethod = item;
            // 			}
            // 		});
            // 	});
            // 	console.log("Cheapest method", cheapestMethod);

            // 	if (self.allowCalendarPreselect) {
            // 		items = self._earliestDelivery;
            // 		items.forEach(function (item) {
            // 			if (cheapestMethod === null || (item.price < cheapestMethod.price)) {
            // 				cheapestMethod = item;
            // 				preselectDay = true;
            // 			}
            // 		});

            // 	}

            // 	if (cheapestMethod) {
            // 		if (preselectDay) {

            // 			this.$$('brick-calendar').chosen = [cheapestMethod.dateStr];
            // 			this._selectedDayDeliveries = self._deliveryDays[cheapestMethod.dateStr];
            // 			window.setTimeout(function () { self._selectMethodByCode(cheapestMethod.code); }, 100)
            // 		}
            // 		else {
            // 			this._selectMethodByCode(cheapestMethod.code);
            // 		}
            // 		//self._selectedItem = cheapestStandard;//.selected = true;
            // 	}

            // },

            // _selectMethodByCode(code) {
            // 	this.$$('#' + code).checked = true;
            // },

            _makeDateStr: function(d) {
                function pad(n, padSize) {
                    var str = n.toString();
                    var padZeros = (new Array(padSize)).join('0');
                    return (padZeros + str).substr(-padSize);
                }
                return (
                    pad(d.getFullYear(), 4) + '-' +
                    pad(d.getMonth() + 1, 2) + '-' +
                    pad(d.getDate(d), 2)
                );
            },

            _deliveryDateSelected: function(e) {
                var deliveries = this._findDayDefiniteDeliveries(e.detail.date);
                if (deliveries && deliveries.length > 0) {//eeee _selectedDayDeliveries should include date as well
                    this._selectedDayDeliveries = { "date": e.detail.date, "deliveries": deliveries };
                } else {
                    this.$$('brick-calendar').chosen = [];
                }
            },

            _findDayDefiniteDeliveries: function(onDate) {
                var dateStr = this._makeDateStr(onDate);
                if (typeof(this._deliveryDays[dateStr]) !== "undefined") {
                    return this._deliveryDays[dateStr];
                } else {
                    return null;
                }

            },

            _formatDayDefiniteDate: function(deliveryDate) {
                return '(Est. arrival: ' + moment(deliveryDate).format("ddd, Do MMM") + ')';
            },

            _formatNonDayDefiniteDate: function(startDate, endDate) {
                return '(Est. arrival: ' + moment(startDate).format("ddd, Do MMM") + ' - ' + moment(endDate).format("d, Do MMM") + ')';
            },

            _findDropPointDeliveries: function(providerId) {
                var self = this;
                //var droppointIndex = providerId;
                if (typeof (this._deliveryDroppoints[providerId]) !== "undefined") {
                    var results = [];
                    for (var service in this._deliveryDroppoints[providerId]) {
                        var item = this._deliveryDroppoints[providerId][service];
                        var obj = {
                            id: item.service.id,
                            methodTitle: item.service.methodTitle,
                            price: item.service.price,
                        };
                        if (item.service.maxDD == item.service.minDD) {
                            // day definite
                            var startDate = new Date(item.deliveryDate);
                            obj.deliveryDateRange = this._formatDayDefiniteDate(startDate);
                        } else {
                            // non day definite
                            var startDate = new Date(item.deliveryDate);
                            var endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + (item.service.maxDD - 1));
                            obj.deliveryDateRange = this._formatNonDayDefiniteDate(startDate, endDate);
                        }
                        results.push(obj);
                    }
                    return results;
                } else {
                    return null;
                }
            },

            //Make a lookup for droppoint provider, allowing all shipping methods for that provider to be returned
            _processDeliveryArray: function (obj) {
                var self = this;
                obj.forEach(function(day) {
                    day.rates.forEach(function(service) {
                        if (service.serviceType.type === "dmStandardDropPoint") {
                            service.serviceType.droppointProviders.forEach(function (provider) {
                                //console.log('PROVIDER:', provider.id, provider.name);
                                if (typeof(self._deliveryDroppoints[provider.id]) === "undefined")
                                    self._deliveryDroppoints[provider.id] = [];
                                if (typeof(self._deliveryDroppoints[provider.id][service.methodTitle]) === "undefined") {
                                    self._deliveryDroppoints[provider.id][service.methodTitle] = {
                                        deliveryDate: day.deliveryDate,
                                        service: service
                                    };
                                } else {
                                	var objsDay = new Date(self._deliveryDroppoints[provider.id][service.methodTitle].deliveryDate);
                                	var droppointDay = new Date(day.deliveryDate);
                                	if (objsDay.getTime() > droppointDay.getTime())
                                    if (self._deliveryDroppoints[provider.id][service.methodTitle].deliveryDate < day.deliveryDate) {
                                        self._deliveryDroppoints[provider.id][service.methodTitle] = {
                                            deliveryDate: day.deliveryDate,
                                            service: service
                                        };
                                    }
                                }
                            });
                        }
                    });
                });
            },

            _findAllDeliveryDroppoints: function() {
                this._processDeliveryArray(this._data.dayDefinite);
                this._processDeliveryArray(this._data.nonDayDefinite);
            },

            _findAllDeliveryDays: function() {
                //Make an index of delivery days, dmStandard
                var self = this;
                this._data.dayDefinite.forEach(function(item) {
                    var dateStr = self._makeDateStr(new Date(item.deliveryDate));
                    var deliveryDate = new Date(dateStr);
                    item.dateStr = dateStr;

                    self._deliveryDays[dateStr] = item.rates.filter(function(rate) {
                    	return (rate.serviceType.type === "dmStandard");
                    });

                    if ((self._earliestDelivery == null) || deliveryDate < self._earliestDelivery) {
                        self._earliestDelivery = self._deliveryDays[dateStr];
                    }
                });
            },

            _markDeliveryDays: function() {
                for (var dateStr in this._deliveryDays) {
                    var selector = 'brick-calendar .day[data-date="' + dateStr + '"]';

					var results = document.querySelectorAll(selector);
					if (results) {
						for (var i = 0; i < results.length; i++) {
							results[i].classList.add('highlighted');
							results[i].classList.add('gfs-checkout');
						}
					}
				}
				//if (this.$.calendarPanel.opened === true) {
					this._preselectForExpress();
				//}
			},

            _calendarMonthChanged: function(e) {
                this._markDeliveryDays();
            },

            _preselectForStandard: function() {
                var cheapestMethod = null;
                var preselectDay = false;
                var items = this._data.standardRates;
                items.forEach(function(carrier) {
                    if (cheapestMethod === null || (carrier.price < cheapestMethod.price)) {
                        cheapestMethod = carrier;
                    }
                });

                this._selectCheapestMethod(cheapestMethod);
            },

			_preselectForExpress: function () {
				var cheapestMethod = null;
				var preselectDay = false;

				if (this.allowCalendarPreselect) {
					items = this._earliestDelivery;
					items.forEach(function (item) {
						if (cheapestMethod === null || (item.price < cheapestMethod.price)) {
							cheapestMethod = item;
							preselectDay = true;
						}
					});
				}

				if (cheapestMethod) {
					if (preselectDay) {
						this.$$('brick-calendar').chosen = [cheapestMethod.deliveryTimeFrom];
						cheapestMethod.date = new Date(cheapestMethod.deliveryTimeFrom);
						this.fire('datetoggleon', cheapestMethod);

						if(this.defaultDelivery === 'Express')
							this._selectCheapestMethod(cheapestMethod);
					}
				}
			},

			_selectCheapestMethod: function(cheapestMethod) {
				cheapestMethod.selected = true;
				var method = this._getDeliveryRateById(cheapestMethod.id);
				this.selectedServiceDetails.serviceId = method.id;
				this.selectedServiceDetails.service = method.methodTitle;
				this.selectedServiceDetails.serviceCode = method.carrierCode;
				this.selectedServiceDetails.carrier = method.carrierName;
				this.selectedServiceDetails.shipping = method.price;
				this.selectedServiceDetails.expDeliveryDateStart = moment(method.deliveryTimeFrom).toISOString();
				this.selectedServiceDetails.expDeliveryDateEnd = moment(method.deliveryTimeFrom).add(method.maxDD - method.minDD, 'days').toISOString();
				this.selectedServiceDetails.checked = cheapestMethod.selected;
				this.selectedServiceDetails.currencySymbol = this.currencySymbol;

                if (this._selectedDropPoint) {
					this.selectedServiceDetails.collectionPoint = this._selectedDropPoint.droppointId;
					this.selectedServiceDetails.deliveryAddress = this._selectedDropPoint.geoLocation;
				} else {
					this.selectedServiceDetails.collectionPoint = null;
					this.selectedServiceDetails.deliveryAddress = actualPost.Request.Order.Transit.Recipient.Location;
				}
				this.fire('selectedservicechanged', this.selectedServiceDetails);
				this.fire("getStandardSelectedService", this.selectedServiceDetails);
			},

            _toggleCollapse: function(id) {
                //If I am open, close everyone
                //If I am closed, open me and close everyone
                var self = this;
                var myElement = this.$$('#' + id);
                var collapseElements = Polymer.dom(this.root).querySelectorAll('iron-collapse');
                var myState = myElement.opened;
                collapseElements.forEach(function(item) {
                    item.opened = false;
                });
                myElement.opened = !myState;
            },

			_toggleCalendarPanelCollapse: function (e) {
				this._toggleCollapse('calendarPanel');

				// if a service is selected disable it
				var standardItems = document.getElementsByClassName("standard-delivery-selection");
				for (var i = 0; i < standardItems.length; i++) {
					standardItems[i].checked = false;
				}

				var droppointItems = document.getElementsByClassName("droppoint-delivery-selection");
				for (var i = 0; i < droppointItems.length; i++) {
					droppointItems[i].checked = false;
				}

				// open available services
				this._preselectForExpress();

				// reset selected service
				this.fire("getStandardSelectedService");
				this.fire("getCalendarSelectedService");
				this.fire("getDroppointSelectedService");
			},

			_toggleStandardDeliveryPanelCollapse: function (e) {
                /*
				this._toggleCollapse('standardDeliveryPanel');

				var calendarItems = document.getElementsByClassName("calendar-delivery-selection");
				for (var i = 0; i < calendarItems.length; i++) {
					calendarItems[i].checked = false;
				}

				var droppointItems = document.getElementsByClassName("droppoint-delivery-selection");
				for (var i = 0; i < droppointItems.length; i++) {
					droppointItems[i].checked = false;
				}

				this.fire("getStandardSelectedService");
				this.fire("getCalendarSelectedService");
				this.fire("getDroppointSelectedService");*/
			},

            closeCheckoutRequest: function() {
				var patchJson = this._getPatchJson();

				if (patchJson != "") {
                    this.$$('#list-spinner').active = true;
                    this.$$('#list-loading').classList.remove('hidden');
                    this.$$('#standard-loading').classList.remove('hidden');
                    this.$.ajaxPatch.url = "///rest.api.checkout.justshoutgfs.com/api/CheckoutSession?sessionId=" + this._sessionId;
                    this.$.ajaxPatch.body = patchJson;
                    this.$.ajaxPatch.headers = this._computeHeader();
                    this.$.ajaxPatch.generateRequest();
                } else {
                    // nothing selected, display an error
                    this.$.errorNotification.text = "No service selected. Please select a service."
                    this.$.errorNotification.show();
                }
            },

			_getPatchJson: function() {
                var actualPatch = "";
                var selectedId = -1;
                var shippingMethods = document.getElementsByName("shipping_method");
                for (var i = 0; i < shippingMethods.length; i++)
                    if (shippingMethods[i].checked)
                        selectedId = shippingMethods[i].id;

                if (selectedId != -1) {
                    if (document.getElementById("standardDeliveriesOption").checked || document.getElementById("calendarDeliveriesOption").checked) {
                        // build selectedService
                        actualPatch = JSON.stringify({
                            closeSession: true,
                            selectedService: {
                                id: selectedId
                            }
                        });
                    } else {
                        // build selectedDroppoint
                        actualPatch = JSON.stringify({
                            closeSession: true,
                            selectedDroppoint: {
                                id: selectedId
                            }
                        });
                    }
                }

                return actualPatch;
			},

            getChosenServiceDetails: function() {
				return JSON.stringify(this.selectedServiceDetails);
            },

            updateDeliveryOptions: function (methodId, dateOverride) {
                var method = this._getDeliveryRateById(methodId);
                this.selectedServiceDetails.serviceId = methodId;
                this.selectedServiceDetails.service = method.methodTitle;
                this.selectedServiceDetails.serviceCode = method.carrierCode;
                this.selectedServiceDetails.carrier = method.carrierName;
                this.selectedServiceDetails.shipping = method.price;
                if (dateOverride) {
                    this.selectedServiceDetails.expDeliveryDateStart = moment(dateOverride).toISOString();
                    this.selectedServiceDetails.expDeliveryDateEnd = moment(dateOverride).toISOString();
                }
                else {
                    this.selectedServiceDetails.expDeliveryDateStart = moment(method.deliveryTimeFrom).toISOString();
                    this.selectedServiceDetails.expDeliveryDateEnd = moment(method.deliveryTimeTo).add(method.maxDD - method.minDD, 'days').toISOString();
                }

                this.selectedServiceDetails.checked = true;
                this.selectedServiceDetails.currencySymbol = this.currencySymbol;

                if (this._selectedDropPoint) {
                    this.selectedServiceDetails.collectionPoint = this._selectedDropPoint.droppointId;
                    this.selectedServiceDetails.providerId = this._selectedDropPoint.providerId;
                    this.selectedServiceDetails.provider = this._selectedDropPoint.providerName;
                    this.selectedServiceDetails.deliveryAddress = this._selectedDropPoint.geoLocation;
                } else {
                    this.selectedServiceDetails.collectionPoint = null;
                    this.selectedServiceDetails.deliveryAddress = actualPost.Request.Order.Transit.Recipient.Location;
                }
                this.fire('selectedservicechanged', this.selectedServiceDetails);
                /*
                if (this.$.standardDeliveriesOption.checked === true)
                    this.fire("getStandardSelectedService", this.selectedServiceDetails);

                if (this.$.calendarDeliveriesOption.checked === true)
                    this.fire("getCalendarSelectedService", this.selectedServiceDetails);

                if (this.$.dropPointDeliveriesOption.checked === true) {
                    this.fire("getDroppointSelectedService", this.selectedServiceDetails);
                }*/
            },

            updateDayDeliveryOptionsEvent: function(e) {
                if (e.target.checked) {
                    this.updateDeliveryOptions(e.target.id, this._selectedDayDeliveries.date); ///eeeee 
                }
            },

            updateDeliveryOptionsEvent: function (e) {
                if (e.target.checked) {                    
                    this.updateDeliveryOptions(e.target.id);
                }
            },

            onUpdateDroppointDeliveryOptions: function(e) {
                this.updateDeliveryOptions(e.detail);
            },

            onSelectTab: function (e) {
                if (e.detail.item.id === "pageCalendar") {
                    this.onShowPage_Calendar();
                }
                else if (e.detail.item.id === "pageStandard") {
                    this.onShowPage_Standard();
                }
                else if (e.detail.item.id === "pageDroppoints") {
                    this.onShowPage_Droppoints();
                }
                else {
                    console.error("Unknown tab");
                }
            },

            showPage_Calendar: function() {              
                this.$.pages.select(1);
                this.onShowPage_Calendar();              
            },

            onShowPage_Calendar: function() {
                this.showingDroppoints = false;
                this.fire('show-calendar');
            },

            showPage_Standard: function () {
                this.$.pages.select(0);
                this.onShowPage_Standard();
			},

			onShowPage_Standard: function() {
			    this.showingDroppoints = false;		   
			    this.fire('show-standard');
			},

            showPage_Droppoints: function () {
                this.$.pages.select(2);
                this.onShowPage_Droppoints();
            },

            onShowPage_Droppoints: function() {
            	if (this._map) {
                    this.showingDroppoints = true;
                    this._showDropPointsView();
                }
            },

			showView_DroppointsList: function() {

			},

			_onSelectPreferredDroppoint: function (e) {
			    console.log("_onSelectPreferredDroppoint()", e.detail);
			},

			_onClickDroppoint: function(e) {
			    this.selectDropPoint(e.detail);
			},

			_doAutoChooseDroppoint: function () {
                //Removing this until we have a droppoint API
                /*
			    if (!this._selectedDropPoint) {
			        var closest = null;
			        if (this._preferredDroppoints && this._preferredDroppoints.length) {
			            closest = this.getClosestDroppoint(this._preferredDroppoints);
			        }
			        else if (this._dropPoints && this._dropPoints.length) {
			            closest = this.getClosestDroppoint(this._dropPoints);
			        }
			        if (closest) {
			            this.chooseDroppoint(closest);
			        }
			    }
                */
			},

			broadcastState: function () {
			    //fire events relating to UI state
			    if (this.showingDroppoints) {
			        this.showPage_Droppoints();
			    }
			    else {
			        //this.showPage_Standard();
			    }
			}

        });
    </script>
</dom-module>